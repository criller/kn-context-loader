# MorphLLM 语义搜索设计方案总结

> 原文：https://morphllm.com/blog/semantic-search  
> 核心观点：结合语义搜索和 grep 可以将智能体准确率提升 31%（大型代码库提升 56%）

## 核心问题

编码智能体在无法找到正确代码时会失败。Grep 适用于精确匹配，但当智能体需要理解"我们在哪里处理身份验证？"这类问题时，grep 无法返回结果。

## 使用场景区分

### 使用 Grep 的场景
- **智能体明确知道要查找什么**
- 模型有高置信度
- 需要查找：`getUserById`、`stripe.charges.create` 或匹配 `*Controller.ts` 的文件
- Grep 可以立即找到

### 使用语义搜索的场景
- **智能体在探索阶段**
- 模型不知道需要什么代码
- 询问："我们在哪里处理速率限制？"或"JWT 验证是如何工作的？"
- 语义搜索理解意图，无需精确关键词即可找到相关代码

## 工作原理

Morph SDK 采用两阶段检索系统：

### 阶段 1：向量搜索（~50ms）
- 使用 HNSW 索引从整个代码库中检索 50 个候选结果

### 阶段 2：GPU 重排序（~150ms）
- 使用 morph-rerank-v4 对候选结果进行精确度评分
- 返回前 10 个结果

**总延迟**：在 1000+ 文件的代码库中约 1230ms

## 实现的重要性

### 低效实现（Lazy Approach）
- 使用 OpenAI text-embedding
- 每 4k token 分块

### 高效实现（Proper Approach）
- **Merkle 树**：监控文件变更（只重新嵌入变更的部分）
- **AST 感知分块**：尊重函数/类边界
- **自定义代码嵌入模型**：针对代码特定模式训练
- **快速数据库查找**：使用 HNSW 索引
- **全局缓存**

**关键区别**：不是语义搜索 vs grep，而是好的语义搜索 vs 差的语义搜索。低效实现会增加延迟而不提高准确性，高效实现使智能体更快、更准确。

## 实验结果

在 50 个代码库（200-5000 文件）的 500 个编码任务基准测试中：

| 配置 | 成功率 | 平均完成时间 |
|------|--------|--------------|
| 仅 Grep | 64.2% | 38.4s |
| 仅语义搜索 | 71.8% | 35.7s |
| **语义搜索 + Grep** | **84.1%** | **21.2s** |

- 语义搜索单独使用比 grep 高 7.6 个百分点
- 两者结合比仅使用 grep 高 19.9 个百分点，**提升 31%**

### 为什么两者都重要

语义搜索缩小到正确的文件，grep 精确定位文件内的确切位置。

**示例工作流**：
1. 智能体询问："我们在哪里验证 JWT 令牌？"（语义搜索）
2. 返回 `auth/middleware.ts`、`utils/jwt.ts`
3. 智能体搜索：`function.*verifyToken`（grep）
4. 找到确切实现

## 大型代码库收益更大

在 1000+ 文件的代码库中，改进更加显著：

| 配置 | 成功率（1000+ 文件） |
|------|---------------------|
| 仅 Grep | 52.3% |
| 仅语义搜索 | 66.1% |
| **语义搜索 + Grep** | **81.7%** |

这是 **56% 的成功率提升**。代码库越大，语义搜索的帮助越大。Grep 随着代码库规模扩大而表现不佳，因为它依赖于知道要查找什么。语义搜索让智能体能够概念性地探索。

## Morph SDK 使用方法

### 1. Push 触发自动索引
```typescript
// 代码示例（原文未提供完整代码）
```

### 2. 使用首选 SDK 搜索
```typescript
// 代码示例（原文未提供完整代码）
```

### 3. 使用 Grep 进行后续精确定位
一旦语义搜索找到正确的文件，使用 grep 查找确切的符号、导入或调用位置。

## 训练方法

- 在真实的智能体会话上训练嵌入和重排序模型
- 使用智能体轨迹来学习实践中"相关"的含义
- 这与 Cursor 的方法一致：在真实的智能体行为上训练，而不是通用的代码相似性
- 标准嵌入模型优化相似性，Morph 的模型优化任务完成

## 核心结论

1. **Grep 适用于模型知道要查找什么时**
2. **语义搜索适用于需要探索时**
3. **两者结合**可以将智能体成功率平均提升 **31%**，在大型代码库中提升 **56%**
4. **实现质量至关重要**：好的语义搜索实现使智能体更快、更准确
5. **Morph SDK** 通过一个导入处理所有复杂性

## 参考

- [MorphLLM 博客原文](https://morphllm.com/blog/semantic-search)
- Cursor 研究显示语义搜索平均准确率提高 12.5%，大型代码库代码保留率提高 2.6%

