# 行动类设计场景方案：生成治疗方案推荐

## 一、场景概述

### 1.1 业务背景

在医疗知识网络中，医生在确诊疾病后，需要为患者生成个性化的治疗方案。这个过程涉及：
- 基于疾病信息（如疾病类型、发病年龄段、是否传染病等）
- 结合患者具体情况（年龄、过敏史、医保覆盖情况等）
- 参考疾病与药物的关联关系（通过"可用药物"关系类查询）
- 生成包含推荐药物、剂量、用法用量、治疗周期等信息的完整治疗方案

### 1.2 场景描述

**角色**：
- **医生**：需要为患者制定治疗方案
- **患者**：患有某种疾病，需要个性化治疗
- **智能体（Agent）**：协助医生生成治疗方案

**典型场景**：
> 患者张三，45岁，被诊断为"高血压"。医生需要为其生成治疗方案，考虑因素包括：
> - 患者年龄是否在高血压发病年龄段内
> - 患者对"青霉素"过敏，需要排除相关药物
> - 患者希望优先选择医保覆盖的药物
> - 需要参考高血压的可用药物，推荐合适的药物产品

## 二、行动类设计

### 2.1 行动类基本信息

**行动类名称**：生成治疗方案推荐（generate_treatment_plan）

**关联对象类**：疾病（disease）

**行动类描述**：基于疾病信息、患者情况和可用药物关系，生成个性化的治疗方案推荐，包含推荐的药物产品、剂量、用法用量、治疗周期等信息。

### 2.2 输入参数设计

行动类需要以下输入参数：

#### 必需参数
- **疾病实例ID**（disease_id）
  - 类型：字符串
  - 说明：需要生成治疗方案的具体疾病实例ID（如"高血压"的ID）
  - 用途：定位具体的疾病对象，查询疾病属性和关联关系

#### 可选参数
- **患者年龄**（patient_age）
  - 类型：整数
  - 说明：患者年龄
  - 用途：判断患者年龄是否在疾病发病年龄段内，某些药物对年龄有限制

- **患者过敏史**（patient_allergies）
  - 类型：字符串数组
  - 说明：患者过敏的药物列表（如["青霉素", "磺胺类"]）
  - 用途：排除不适用药物，确保用药安全

- **医保覆盖偏好**（insurance_coverage）
  - 类型：布尔值
  - 说明：是否优先选择医保覆盖的药物
  - 用途：根据患者需求，优先推荐医保药物以降低患者负担

### 2.3 条件关联设计（前置条件）

条件关联定义了行动类执行的前置条件，只有满足所有条件时才能执行：

#### 条件1：疾病已确诊
- **条件名称**：疾病实例存在且有效
- **条件描述**：疾病实例必须存在，且疾病名称不为空
- **业务含义**：确保针对的是已确诊的疾病，不能对不存在的疾病生成方案
- **技术实现**：检查疾病对象实例是否存在，disease_id对应的疾病对象不为空

#### 条件2：存在可用药物
- **条件名称**：疾病有关联的可用药物
- **条件描述**：该疾病必须通过"疾病 → 可用药物 → 药物"关系类关联到至少一种药物
- **业务含义**：如果疾病没有可用药物，无法生成治疗方案
- **技术实现**：查询"cures"关系类，检查是否存在从该疾病实例出发的关系实例

#### 条件3：年龄匹配（可选）
- **条件名称**：患者年龄在疾病发病年龄段内
- **条件描述**：如果提供了患者年龄，该年龄应在疾病对象的"发病年龄段"属性范围内
- **业务含义**：某些疾病在不同年龄段有不同的治疗方案，需要确保年龄匹配
- **技术实现**：如果提供了patient_age，检查disease.age属性是否包含该年龄

**条件关联的作用**：
- 确保行动在合适的时机执行，避免无效操作
- 提供业务规则约束，保证执行的安全性
- 为智能体提供"事实判断"的依据

### 2.4 影响关联设计（执行结果）

影响关联描述了行动执行后对知识网络的影响：

#### 影响1：生成治疗方案对象
- **影响类型**：创建新对象
- **目标对象类**：治疗方案（treatment_plan）
- **影响描述**：行动执行后，会创建一个新的治疗方案对象，包含：
  - 治疗方案ID
  - 关联的疾病实例
  - 推荐的药物列表
  - 每个药物的剂量、用法用量
  - 治疗周期
  - 预估费用
  - 注意事项和警告
- **业务含义**：记录生成的治疗方案，便于后续查询和追溯

#### 影响2：关联推荐药物产品
- **影响类型**：建立关联关系
- **目标对象类**：药物产品（drug_product）
- **影响描述**：治疗方案中推荐的每个药物产品，都会建立与治疗方案的关联关系
- **业务含义**：明确治疗方案中具体使用的药物产品，便于后续查询和管理

**影响关联的作用**：
- 明确行动执行后的结果，便于追踪和审计
- 为智能体提供"决策推导"的依据
- 支持后续的查询和分析

### 2.5 资源映射设计（实际执行）

资源映射将行动类映射到实际的技术资源：

#### 映射目标：医疗治疗方案生成MCP服务
- **资源类型**：MCP（Model Context Protocol）服务
- **服务标识**：medical_treatment_plan_mcp
- **服务描述**：医疗系统的治疗方案生成服务，基于疾病、患者信息、可用药物等生成个性化治疗方案

#### 参数映射
将行动类的输入参数和查询结果映射到MCP服务的调用参数：
- **disease_id** → 直接传递给MCP服务
- **disease_name** → 通过查询疾病对象获取，传递给MCP服务
- **patient_age** → 直接传递给MCP服务
- **patient_allergies** → 直接传递给MCP服务
- **insurance_coverage** → 直接传递给MCP服务
- **available_drugs** → 通过查询"cures"关系类获取可用药物列表，传递给MCP服务

#### 执行流程
1. 接收行动类调用请求
2. 检查条件关联是否满足
3. 查询相关数据（疾病信息、可用药物关系）
4. 将参数映射到MCP服务调用格式
5. 调用MCP服务执行实际的治疗方案生成
6. 处理MCP服务返回的结果
7. 创建影响关联中定义的对象和关系
8. 返回执行结果

**资源映射的作用**：
- 将抽象的业务操作转化为可执行的技术调用
- 实现"业务意图 → 执行指令"的零语义损耗转换
- 支持端到端的自动化执行

## 三、与知识网络其他部分的关系

### 3.1 与对象类的关系

**关联对象类**：疾病（disease）

- 行动类关联到"疾病"对象类，意味着这个行动是针对疾病实例执行的
- 行动类可以访问疾病对象的所有属性（如疾病名称、ICD编码、发病年龄段、是否传染病、治疗费用、治愈率、治疗方案等）
- 行动类执行时，需要指定具体的疾病实例ID

### 3.2 与关系类的关系

**利用的关系类**：

1. **疾病 → 可用药物 → 药物**（cures关系类）
   - 用于查询该疾病有哪些可用药物
   - 这是生成治疗方案的核心数据来源

2. **药物 → 可选药品 → 药物产品**（is_a_drug关系类）
   - 用于从药物进一步查询具体的药物产品
   - 治疗方案需要推荐具体的药物产品（如"阿司匹林片剂100mg"），而不是抽象的"阿司匹林"

**可能创建的关系类**：

- **治疗方案 → 包含药物 → 药物产品**（新关系类）
  - 用于记录治疗方案中推荐的具体药物产品
  - 这是影响关联的一部分

### 3.3 与资源的关系

**数据资源**：
- 疾病对象类映射的数据视图：用于查询疾病实例的属性
- 关系类映射的数据视图：用于查询疾病与药物的关联关系

**逻辑资源**：
- 治疗方案生成算法：可能涉及药物相互作用检查、剂量计算等逻辑

**行动资源**：
- 医疗治疗方案生成MCP服务：实际执行治疗方案生成的工具

## 四、执行流程示例

### 4.1 场景：为高血压患者生成治疗方案

**输入**：
- 疾病实例ID：`hypertension_001`（高血压）
- 患者年龄：45
- 患者过敏史：["青霉素"]
- 医保覆盖偏好：true

**执行步骤**：

1. **接收请求**
   - Agent调用行动类：`execute_action("generate_treatment_plan", disease_id="hypertension_001", patient_age=45, patient_allergies=["青霉素"], insurance_coverage=true)`

2. **检查条件关联**
   - ✅ 检查疾病实例是否存在：查询疾病对象，确认"高血压"存在
   - ✅ 检查是否存在可用药物：查询"cures"关系类，确认高血压关联到"阿司匹林"、"硝苯地平"等药物
   - ✅ 检查年龄匹配：查询疾病对象的"age"属性，确认45岁在高血压发病年龄段内

3. **查询相关数据**
   - 查询疾病属性：获取高血压的ICD编码、治疗周期、治愈率等信息
   - 查询可用药物：通过"cures"关系类，查询高血压的所有可用药物（如"阿司匹林"、"硝苯地平"、"卡托普利"等）
   - 查询药物产品：通过"is_a_drug"关系类，查询每个药物的具体产品（如"阿司匹林片剂100mg"、"硝苯地平缓释片30mg"等）
   - 过滤过敏药物：排除与"青霉素"相关的所有药物产品
   - 优先医保药物：根据"insurance_coverage"参数，优先选择医保覆盖的药物产品

4. **调用资源执行**
   - 构建MCP服务调用参数：
     ```json
     {
       "disease_id": "hypertension_001",
       "disease_name": "高血压",
       "patient_age": 45,
       "patient_allergies": ["青霉素"],
       "insurance_coverage": true,
       "available_drugs": ["阿司匹林", "硝苯地平", "卡托普利"],
       "available_drug_products": [
         {"drug_product_id": "aspirin_100mg", "drug_name": "阿司匹林片剂100mg", "insurance": true},
         {"drug_product_id": "nifedipine_30mg", "drug_name": "硝苯地平缓释片30mg", "insurance": true}
       ]
     }
     ```
   - 调用MCP服务：`POST mcp://medical-system/treatment-plan/generate`
   - MCP服务基于临床指南和算法生成治疗方案

5. **处理影响关联**
   - 创建治疗方案对象：
     ```json
     {
       "treatment_plan_id": "tp_20240115_001",
       "disease_id": "hypertension_001",
       "recommended_drugs": [
         {
           "drug_product_id": "aspirin_100mg",
           "drug_name": "阿司匹林片剂100mg",
           "dosage": "100mg",
           "frequency": "每日一次",
           "duration": "长期服用",
           "notes": "饭后服用，注意胃肠道反应"
         },
         {
           "drug_product_id": "nifedipine_30mg",
           "drug_name": "硝苯地平缓释片30mg",
           "dosage": "30mg",
           "frequency": "每日一次",
           "duration": "长期服用",
           "notes": "注意监测血压"
         }
       ],
       "treatment_period": "长期",
       "estimated_cost": 150.00,
       "warnings": ["定期监测血压", "注意药物相互作用"]
     }
     ```
   - 建立治疗方案与药物产品的关联关系

6. **返回结果**
   - 返回生成的治疗方案，包含：
     - 推荐药物列表（已排除过敏药物）
     - 每个药物的剂量、用法用量
     - 治疗周期
     - 预估费用
     - 注意事项

### 4.2 执行失败场景

**场景**：疾病没有可用药物

**执行步骤**：
1. 接收请求：为"罕见病X"生成治疗方案
2. 检查条件关联：
   - ✅ 疾病实例存在
   - ❌ **不存在可用药物**：查询"cures"关系类，发现该疾病没有关联任何药物
3. **执行终止**：由于条件关联不满足，行动类不执行，返回错误信息："该疾病暂无可用药物，无法生成治疗方案"

## 五、行动类的价值

### 5.1 业务价值

1. **自动化提升效率**
   - 医生无需手动查询疾病可用药物、逐一筛选、组合方案
   - 系统自动完成数据查询、过滤、组合，生成完整方案

2. **个性化提升质量**
   - 基于患者年龄、过敏史、医保情况等个性化因素
   - 确保方案安全、有效、经济

3. **安全性保障**
   - 通过条件关联确保执行前提（疾病已确诊、有可用药物）
   - 自动排除过敏药物，避免用药风险

4. **可追溯性**
   - 通过影响关联记录生成的治疗方案
   - 便于后续查询、审计、优化

### 5.2 技术价值

1. **语义化表达**
   - 将"生成治疗方案"这个业务操作抽象为可理解的概念定义
   - AI可以理解这个操作的含义、输入、输出、条件

2. **可复用性**
   - 同一行动类可以应用于不同的疾病实例
   - 不需要为每种疾病单独定义行动类

3. **可扩展性**
   - 可以增加新的条件关联（如"患者肾功能正常"）
   - 可以增加新的影响关联（如"生成用药提醒"）
   - 可以调整资源映射（如切换到新的MCP服务）

4. **端到端自动化**
   - 从业务意图到技术执行的完整链路
   - 支持Agent自动调用和执行

## 六、设计原则总结

### 6.1 行动类设计的核心要素

1. **关联对象类**：明确行动针对哪个对象类
2. **输入参数**：定义需要什么信息才能执行
3. **条件关联**：定义什么时候可以执行（前置条件）
4. **影响关联**：定义执行后会产生什么影响（结果）
5. **资源映射**：定义实际如何执行（技术实现）

### 6.2 行动类与对象类、关系类的协同

- **对象类**：定义"是什么"（疾病是什么）
- **关系类**：定义"有什么关系"（疾病和药物有什么关系）
- **行动类**：定义"能做什么"（基于疾病能执行什么操作）

三者共同构成完整的业务知识网络概念定义体系。

### 6.3 行动类的本质

行动类是**"目标到执行的语义桥梁"**，它：
- 将抽象的业务目标转化为可执行的操作
- 通过条件关联提供"事实判断"依据
- 通过影响关联提供"决策推导"依据
- 通过资源映射实现端到端的自动化执行

## 七、后续扩展方向

### 7.1 可能的扩展

1. **增加更多条件关联**
   - 患者肾功能检查结果
   - 患者肝功能检查结果
   - 患者是否有其他并发症

2. **增加更多影响关联**
   - 生成用药提醒（关联到提醒系统）
   - 生成复查计划（关联到检查项目）
   - 记录治疗方案到患者病历（关联到病历系统）

3. **增加更多输入参数**
   - 患者体重（用于计算药物剂量）
   - 患者既往病史
   - 患者当前用药情况（避免药物相互作用）

4. **增加更多资源映射**
   - 药物相互作用检查服务
   - 药物剂量计算服务
   - 医保报销查询服务

### 7.2 其他可能的行动类

基于医疗知识网络，还可以设计其他行动类：

1. **预约检查**（关联到"检查项目"对象类）
   - 基于疾病的检查项关系，为患者预约相关检查

2. **发送诊断报告**（关联到"疾病"对象类）
   - 基于疾病信息生成诊断报告并发送给患者

3. **药物库存查询**（关联到"药物产品"对象类）
   - 查询推荐药物产品的库存情况

4. **科室转诊**（关联到"疾病"对象类）
   - 基于疾病的分诊科室关系，为患者安排转诊

---

**文档版本**：v1.0  
**创建时间**：2024-01-15  
**最后更新**：2024-01-15  
**状态**：设计方案

