# V2 交互分析：场景输出与澄清策略（工具优先）

目的
- 回到“场景交互分析”主题，基于 02-场景分析 的既有场景，明确每类场景的输出是什么，以及在结构化与自然语言查询下如何采用守护与澄清策略。
- 坚持检索工具为核心：默认先执行、在安全范围内返回可用结果；澄清仅作为降低错误与规模风险的配套机制。

参考与对齐
- 场景来源：/02-场景分析/（总览、实例检索、子图、关系与路径、属性、聚合、集合运算、文本检索RAG、混合模式、澄清）。
- 守护规则：/04-场景交互分析/Guardrails-规模守护与自动降级.md。
- 澄清规则：/04-场景交互分析/Clarify-触发判定规则.md 与 Clarify-触发与话术模板.md。

---

一、给予整理的不同类型场景：输出是什么？（对齐 02-场景分析）

1) 实例检索（Entity Lookup，M1）
- 输出形态：实体列表与基础信息摘要。
- 最小字段集合：id、name、type；常见基础信息如 address、brief_info（具体以各对象的基础属性为准）。
- 示例对齐：SC-001/002/003/004/005（企业/园区/专利/物料/反应/工艺）。
- 元数据（透明记录）：采用的默认排序（相关性）、数量限制（≤30）、别名归一情况、是否发生软降级。

2) 子图查询（Neighborhood/Expand，M1）
- 输出形态：本地子图的节点清单与边清单；可附带节点/边计数与方向/深度说明。
- 最小字段集合：node_list[{id,type,name,...}]、edge_list[{source_id,target_id,relation_type,direction}]; depth, relation_types。
- 示例对齐：SG-001/002/003/004/005/006/007。
- 元数据：默认方向（业务常见方向）、默认深度（=1）、数量阈值（图≤50节点），是否过滤与降级说明。

3) 关系确认与路径查询（Relation/Path，M1/M2）
- 输出形态：
  - 关系确认（M1）：若存在该一跳边，返回边与相邻节点；否则返回“未找到该关系”的明确说明。
  - 路径查询（M2）：在约束内返回最短路径或路径集合（受限）。
- 最小字段集合：
  - 关系确认：exists:boolean；edges[]；nodes[]；relation_type；direction。
  - 路径查询：paths[ { nodes[], edges[], length } ]；策略（最短/全部匹配）；约束（关系类型、最大长度）。
- 示例对齐：RP-001/002（M1），RP-003（M2），RP-004/005（反向一跳）。
- 元数据：默认方向与深度、一跳/最短路径策略、是否发生降级（改为一跳或缩小范围）。

4) 属性获取（Attribute Fetch，M1）
- 输出形态：指定对象的属性值集合；缺失时给出明确说明。
- 最小字段集合：entity_id、entity_type、fields[{name,value}]。
- 示例对齐：AT-001/002/003；AT-004 当前暂不支持边属性（返回“暂不支持”的说明）。
- 元数据：字段别名归一情况、条件限定（最新值/状态/时间范围）、缺失值提示。

5) 文本检索 / RAG（Texts，M2）
- 输出形态：命中文本片段集合（可高亮），附关联实体的标识。
- 最小字段集合：entity_id/entity_type、text_field、snippet、highlighted_terms、score（可选）。
- 示例对齐：TX-001/002/003/004/005。
- 元数据：默认排序（相关性）、数量限制（≤30）、是否发生软降级。

6) 聚合与统计（Aggregate，M2）
- 输出形态：分组与计数/聚合结果集。
- 最小字段集合：group_keys[]、metric_name、metric_value；可附 dedup 说明。
- 示例对齐：AG-001/002/003/004（去重口径示例）。
- 元数据：去重策略（id/edge/fields）、排序与限制、是否发生降级。

7) 集合运算与比对（Set/Compare，M2）
- 输出形态：交/并/差集的实体集合；相似度计算的分值与集合大小说明。
- 最小字段集合：result_set[]（id,type,name,...）；op_name（intersection/union/difference）；similarity（可选）。
- 示例对齐：ST-001/002/003/004/005（含业务键连接与去重）。
- 元数据：连接策略（join_strategy/join_fields）、去重策略与字段、规模控制说明。

8) 混合模式（Hybrid，M1）
- 输出形态：在一个查询中同时使用实例筛选、邻域扩展、属性返回、过滤/排序等组合后的结果；结构与上述各场景一致，按具体组合返回。
- 最小字段集合：按组合场景继承（如 seed_set、relation_path、node_filter、return_fields）。
- 示例对齐：HY-001/002/003/004/005/006/007。
- 元数据：各默认值与降级记录，组合操作的语义说明（如“先检索实体，再反向查企业，再到园区”）。

---

二、结构化查询：精准，无歧义；澄清仅用于防规模爆炸与延迟/配额风险
- 适用判断：
  - 明确给定对象类型/主键/过滤条件/关系类型/方向/深度等结构化参数，意图与范围清晰；
  - 输入不依赖自然语言解析（或仅作为注释），不涉及实体歧义与模糊语义。
- 守护与降级（对齐 Guardrails）：
  - 默认深度=1；默认数量阈值：列表≤30、图≤50；默认方向采用业务常见方向；默认时间窗口：近三年（在集合基数较大且未指定时）。
  - 自动降级（软降级优先）：规模预测≫阈值时，先按阈值执行并提示“加条件或查看更多”；请求深度>1时，先返回一跳并提示“可扩展到两跳”。
  - 阻断澄清门槛：预估规模>2000（造成显著延迟/配额风险）、合规/风控必须确认。
- 响应透明：每次执行记录默认值与降级项及可能的语义影响；结果页给自然语言“一键操作”。

---

三、自然语言查询：存在歧义；需要澄清策略（软澄清为主，阻断仅在高风险）
- 典型歧义类型（对齐 Clarify 触发规则）：
  1) 实体/名称歧义（Entity Linking）：top1 置信度低或与 top2 接近；候选多且相似；
  2) 关系类型/方向未指明：多个候选关系均可能合理；
  3) 规模与深度风险：集合基数大或多跳扩展易爆炸；
  4) 过滤缺失：未指定时间/状态/地域/类型却基数较大；
  5) 字段别名与口径统一：属性名/统计口径差异导致结果语义不一致；
  6) 能力越界（超出 M1 能力）：复杂路径/组合聚合；
  7) 合规/风控：敏感范围或必须确认；
  8) 配额/并发：需要分批返回或建议缩小范围；
  9) 输入矛盾：互斥条件并存（如地域或时间矛盾）。
- 决策流程：
  - Step 1 NL 解析→草案计划（对象/关系/方向/深度/过滤/规模预测）。
  - Step 2 计算信号：实体置信/差值、规模预测、深度、过滤缺失、能力越界、合规标记、矛盾检测。
  - Step 3 判定类型：若命中阻断条件（高风险/合规/极端规模），执行前澄清；否则默认先执行并附“轻提示”。
  - Step 4 响应内容：结果+解释（默认值/降级/可能影响）+快速指令（只看在营/近三年/只看园区/扩展到两跳/按时间排序/多给一些）。
- 话术与体验：采用自然语言微文案，默认不暴露技术参数；Agent 模式可在元数据附结构化参数。

---

四、与现有文档的对齐与下一步
- 本文件已对齐并引用：
  - 02-场景分析（输出与期望）：0、场景分析总览.md；场景用例表.md；2、实例检索；3、子图查询；4、属性获取；5、关系与路径查询；10、文本检索RAG；7、混合模式等。
  - 04-场景交互分析（规则与体验）：Guardrails-规模守护与自动降级.md；Clarify-触发判定规则.md；Clarify-触发与话术模板.md。
- 下一步：
  1) 针对每类场景补充“输出契约明细”（字段级，按你们对象模型），形成可验收的统一格式；
  2) 将结构化与 NL 查询的守护/澄清示例嵌入 M1-场景交互模拟-合集.md；
  3) 根据你们的默认阈值偏好（当前：列表30、图50、近三年；或更保守），固化到守护策略并在结果页以微文案呈现。

验收指标（体验导向，延续既有标准）
- 默认执行满足率≥80%；阻断澄清比例≤20%；自然语言可读性≥95%；透明解释率≥95%。

备注
- 所有默认值、阈值与口径可按你们业务调整；本文件不涉及实现细节与接口参数定义，专注“输出是什么”与“何时澄清”。