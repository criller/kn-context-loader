# 架构设计-系统与数据流（M1/M2 兼容扩展）

一、组件划分（模块化，可插拔）
- Query Gateway（统一入口）
  - 提供 HTTP/JSON 接口，校验请求 Schema 与权限（鉴权后置到 M2）。
- Intent Parser & Query Planner（意图解析与计划）
  - 支持 mode=nl/exact/hybrid；输出标准化 QueryPlan：concepts/relations/direction/depth/filters/limit/order_by。
  - Grounding：对象/关系/实体候选与置信度；别名与术语归一。
- Guardrails（规模守护与自动降级）
  - 依据 capabilities 与默认阈值（列表≤30、图≤50、近三年窗口）预测规模并降级（限制数量/改一跳/提示扩展）。
- ClarifyEngine（澄清引擎）
  - 触发判定：歧义/规模风险/能力越界/合规/矛盾；输出澄清问题、候选与建议项；软澄清为主，阻断少量高风险。
- Executors/Adapters（底层能力适配器）
  - InstanceSearchAdapter：实例检索（字段过滤/模糊/别名归一/排序/分页）。
  - SubgraphAdapter：子图查询（relation_types/方向/深度/节点属性过滤/规模守护）。
  - RelationAdapter：关系确认（一跳边存在性与节点/边返回）。
  - AttributeAdapter：属性获取（对象属性读取/别名归一/缺失说明）。
  - PathAdapter（M2）：约束路径与最短路径。
  - AggregateAdapter（M2）：分组与计数/Top-K，含去重策略。
  - SetOpsAdapter（M2）：交并差与相似度（如Jaccard）。
  - TextSearchAdapter（M2/RAG）：文本字段检索与片段返回，支持高亮。
- Result Formatter（结果格式化）
  - 统一结构：entities[]、subgraph{nodes[],edges[]}、texts[]，附 explain/plan/metrics/defaults/degeneration。
- Capabilities Registry（能力注册）
  - 管理各 Adapter 的真实底层接口 URL/方法/参数与限额（max_depth/max_nodes/max_limit 等）。
- Aliases & Synonyms（字段与术语归一）
  - 维护对象/属性/关系的别名映射；支持“授权日期→grant_date”等归一。
- Metrics & Logging（指标与日志）
  - 采集 latency/calls/size/clarify-trigger/degeneration，支持 A/B 与告警。
- Config（默认阈值与策略）
  - 方向默认、一跳默认、窗口默认、limit 默认、clarify 阈值；按业务可调。

二、数据与控制流（请求到响应）
1) 接入（Gateway）
- 校验请求（mode/options/graph/filters）；解析 profile（precision/recall/balanced）。
2) 计划（Planner）
- nl：解析对象/关系/方向/深度/过滤与规模预测；输出 QueryPlan 与 grounding（候选与置信度）。
- exact/hybrid：合并结构化限定，形成可执行计划；记录默认与偏好（profile）。
3) 守护与澄清（Guardrails/Clarify）
- 规模预测超阈值→自动降级并记录；命中阻断条件→澄清（实体/方向/深度/去重/连接键）。
- dry-run=true→仅返回 plan/explain/metrics，不执行。
4) 执行（Adapters）
- 路由到对应 Adapter；并行/串行组合（Hybrid：先实例筛选→再子图扩展→属性返回）。
- 执行时应用 direction/depth/filters/limit/order_by；必要时做去重（按 id/edge/fields）。
5) 格式化与返回（Formatter）
- results：entities[]、subgraph{nodes[],edges[]}、texts[]；
- meta：plan[]、metrics{latency,calls,size}、intent/confidence、grounding{concepts/relations/entities}、defaults/degeneration（降级项与可能影响）。

三、数据存储与索引（对齐 TBox 与场景）
- 图存储（KG）：对象与关系（nodes/edges）；支持 relation_types、正/反/双向邻域、深度扩展；节点属性过滤。
- 文本与向量索引（M2/RAG）：对象的文本属性（abstract/description/flow/safety_notes 等）；BM25 与向量检索并排。
- 结构化索引：常用过滤字段（status/ipc/cas_no/hazard_class/grant_date 等）。
- 别名字典：对象/关系/属性的映射与归一；术语库（IPC/危化品类别等）。
- 缓存：热门实体与邻域、常用统计；游标/分页支撑大集合分批。

四、规模守护与降级策略（默认值可调）
- 列表≤30、图≤50 安全；31–200 软澄清并限制；>2000 阻断或分步。
- 深度：>1 软澄清（先返回一跳并提示扩展）；>3 且规模高可能阻断。
- 时间窗口：未指定且集合大→默认近三年；可提示调整。
- 去重：多对多关系默认按实体 id 去重；统计时可按字段去重（dedup_fields）。

五、部署拓扑（建议）
- 服务：
  - gateway（无状态，水平扩展）
  - planner（可与 gateway 同容器或独立）
  - adapters（按能力拆分微服务：instance/subgraph/relation/attribute；M2 再增 path/aggregate/set/text）
  - clarify（触发与话术模板服务）
  - registry（capabilities 与别名配置）
  - metrics（时延与规模采集，推送到监控）
- 存储：
  - graph-db（Neo4j/JanusGraph/TigerGraph/自研接口）
  - search-index（Elastic/OpenSearch）与 vector-index（FAISS/Milvus/pgvector）
  - config-store（Redis/Etcd）与 cache（Redis）
- 观测：
  - tracing 与日志（plan/clarify/degeneration）
  - 指标告警（响应时延、规模超限、clarify 触发比例）

六、扩展性与演进
- 能力注册：新增 Adapter 只需在 capabilities 中声明 URL/方法/限额与支持的参数映射。
- 策略配置：clarify 阈值、默认方向/深度/limit、时间窗口可按业务场景调优。
- 混排（M2）：BM25/Embedding/Cross-Encoder 重排序；结果融合（图/文本/结构化）。
- 合规与鉴权（后续）：多租户、字段级可见性、审计日志与配额管理。