# 模块设计：统一检索接口（v1 草案，需求原型对齐）

目标与范围
- 为分析师与 AI/Data Agent 提供统一、透明、可澄清的检索入口，覆盖 M1 六类场景；兼容后续 M2 能力扩展。
- 与《需求示例-统一检索接口（原型）》和《统一检索项目需求说明》保持一致，字段口径以本草案为起点，评审后固化至 Schema。

接口形态（HTTP/JSON）
- POST /api/search/unified
- Headers：Content-Type: application/json；X-Client-Profile（precision/recall/balanced）

请求结构（草案）
- mode: nl | exact | hybrid
- nl_query: { text: string }
- exact_query: {
  concept?: string,
  entity_id?: string,
  filters?: [{ field: string, op: string, value: any }],
  graph?: { relation_types?: string[], direction?: 'out'|'in'|'both', depth?: number }
}
- options?: { limit?: number, offset?: number, order_by?: string, response_format?: 'compact'|'verbose', explain?: boolean, dry_run?: boolean }
- profile?: 'precision'|'recall'|'balanced'

响应结构（统一返回）
- results?: {
  entities?: [{ id, type, name, ... }],
  subgraph?: { nodes: [{ id, type, name, ... }], edges: [{ source_id, target_id, relation_type, direction }] },
  texts?: [{ entity_id, entity_type, text_field, snippet, highlight_terms?, score? }]
}
- clarify?: {
  triggered: boolean,
  reason?: string,
  questions?: string[],
  candidates?: { concepts?: string[], relations?: string[], entities?: [{ id, name, type, attrs? }], directions?: ['out','in','both'], depths?: number[], filters_suggestions?: any[], limit_suggestions?: number[] },
  suggestions?: string[]
}
- meta: {
  plan: any[],
  metrics: { latency_ms, calls, size: { entities?, nodes?, edges?, texts? } },
  intent?: { concepts: string[], relations: string[], entities?: any[], confidence?: number },
  grounding?: { concepts?: any[], relations?: any[], entities?: any[] },
  defaults?: { direction?, depth?, limit?, time_window? },
  degeneration?: [{ type: 'limit'|'depth'|'filter'|'timeout', detail: string }]
}
- error?: { code: string, message: string, step?: string, suggestion?: string }

错误码与建议（示例）
- E_SCHEMA_INVALID：请求结构不合法 → 返回示例与校验错误
- E_CAPABILITY_LIMIT：超出能力或限额（depth/limit）→ 自动降级并记录；必要时阻断澄清
- E_AMBIGUITY_BLOCKED：歧义严重需确认 → 返回 clarify 问题与候选
- E_NOT_SUPPORTED：暂不支持的能力（M2 扩展）→ 返回替代建议（子图/客户端聚合）
- E_BACKEND_ERROR：底层接口失败 → 返回 step 与重试建议

执行规则（摘要）
- dry_run=true：仅返回 plan/explain/metrics，不执行；clarify 可触发问题与候选。
- 默认策略：
  - 方向：一跳/路径默认正向；子图默认双向。
  - 深度：默认=1；>1 触发软澄清（先返回一跳并提示扩展）。
  - 规模：列表≤30、图≤50；超限软澄清并限制；>2000 阻断或分步。
  - 时间窗口：未指定且集合大→默认近三年。
- 去重与连接：
  - 多对多关系默认按实体 id 去重；统计可按字段去重（dedup_fields）。
  - join_strategy=by_id|field_equality|external_edge；默认 by_id，字段 ["id"]。

场景映射（示例）
- 实例检索（SC-001/002/003/004/005）：exact_query.concept + filters；results.entities。
- 子图查询（SG-001/002/...）：exact_query.graph{relation_types,direction,depth}；results.subgraph。
- 关系确认（RP-001/002/004/005）：graph.depth=1 + target 指定；results.subgraph.edges 与 exists。
- 属性获取（AT-001/002/003）：exact_query.concept/entity_id + filters；results.entities[].attrs。
- 混合模式（HY-*）：nl_query + exact_query.graph/filters；组合执行；results.entities/subgraph。
- 文本检索/RAG（TX-*，M2）：text_fields + text_query；results.texts。
- 聚合/集合（AG-*/ST-*，M2）：aggregation/set_op；results.entities 或 metrics。

与 capabilities 对齐
- 需提供真实 capabilities.json（URL/方法/参数/限额），Planner 依据其路由与校验；本文件保留字段占位与策略说明。

鉴权与配额（后续）
- 多租户与字段级可见性；角色/配额限制与审计；错误结构统一。