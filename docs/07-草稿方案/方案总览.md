# 统一检索方案总览（基于现有文档对齐版）

目标与定位
- 面向“业务知识网络”，交付一个统一、透明、可澄清的检索入口，支撑分析师与 AI/Data Agent 的稳定复用。
- 优先落地 M1 六类核心场景：实例检索、子图查询、关系确认（一跳）、属性获取、澄清 Clarify、混合模式 Hybrid；M2 规划能力：路径、聚合与统计、集合运算与比对、文本检索/RAG。
- 响应内置 explain/plan/metrics，支持 dry-run（仅解释与计划）与执行模式；规模守护与自动降级透明呈现。

范围与优先级（M1/M2）
- M1（两周原型）：
  1) 实例检索（Entity Lookup）
  2) 子图查询（Neighborhood/Expand）
  3) 关系确认（一跳）
  4) 属性获取（对象属性）
  5) 澄清（Clarify）
  6) 混合模式（Hybrid：NL+结构化限定）
- M2（增强阶段）：路径查询、聚合与统计、集合运算与比对、文本检索/RAG、排序与打分（BM25/Embedding 混排）、Clarify 阈值完善、鉴权与多租户。

核心原则
- 工具优先：默认先执行安全规模的检索；澄清用于降误检与守规模，阻断澄清仅在高风险场景。
- 统一口径：方向（正/反/双）、深度、去重、连接策略（by_id/field_equality）、统计口径需显式并在结果中解释。
- 透明可解释：每次响应包含意图识别、计划、默认值与降级项、限制与可能影响；支持 dry-run。
- 可扩展：模块化（Planner/Adapters/Formatter/Validator/Clarify），新增能力按 capabilities 注册接入。

能力矩阵与对应模块
- 实例检索 → InstanceSearchAdapter（字段过滤/模糊/别名归一/排序/分页）
- 子图查询 → SubgraphAdapter（relation_types/方向/深度/节点属性过滤/规模守护）
- 关系确认 → RelationAdapter（一跳边存在性与节点/边返回）
- 属性获取 → AttributeAdapter（对象属性读取/别名归一/缺失说明）
- 混合模式 → Hybrid Orchestrator（NL+Exact 合成；在基本能力范围执行并应用限定）
- 澄清 → ClarifyEngine（触发判定、话术模板、候选与建议项；软澄清为主、阻断少量高风险）
- M2 扩展：PathAdapter/AggregateAdapter/SetOpsAdapter/TextSearchAdapter（RAG）

架构摘要（详细见《架构设计-系统与数据流.md》）
- Query Gateway（统一HTTP入口）→ Intent Parser & Query Planner（nl/exact/hybrid）→ Guardrails（规模与降级）→ ClarifyEngine（必要时）→ Executors/Adapters（实例/子图/关系/属性/RAG/集合/聚合）→ Result Formatter（entities/subgraph/texts + meta）。
- Capabilities Registry（真实底层接口能力与限额）；Aliases & Synonyms（字段/术语归一）；Metrics & Logging（时延、规模、降级与澄清记录）；Config（默认阈值与策略，业务可调）。

接口与响应（草案，详见《模块设计-统一检索接口.md》）
- 请求：mode=nl/exact/hybrid；nl_query{text}；exact_query{concept/entity_id, filters[], graph{depth, relation_types, direction}}；options{limit/order_by/offset/response_format/explain/dry_run}；profile{precision/recall/balanced}。
- 响应：results{entities[], subgraph{nodes[], edges[]}, texts[]}；meta{plan[], metrics{latency,calls,size}, intent/confidence, grounding{concepts/relations/entities}, defaults/degeneration}。

TBox与数据模型约定（摘自《01-概念约定》与化工示例）
- 对象类型示例：enterprise/park/patent/material/reaction/process；属性如 enterprise.address、patent.status/grant_date、material.cas_no/formula/storage_requirements。
- 关系类型示例：enterprise_2_park（坐落在）、enterprise_2_patent（拥有专利）、enterprise_2_material（生产物料）、material_2_reaction（参与反应）、reaction_2_material（产物）、material_2_process（参与消耗）。
- 连接策略与基数：join_strategy=by_id|field_equality|external_edge；source/target_join_fields；cardinality=one_to_one|one_to_many|many_to_one|many_to_many。默认 by_id，字段 ["id"]。

守护与澄清（对齐《04-场景交互分析》）
- 默认阈值（可调）：列表≤30、图≤50；近三年时间窗口；一跳默认正向，子图默认双向。
- 自动降级：规模预测超阈值→限制数量/改为一跳/提示扩展；在响应中透明记录。
- Clarify 触发：实体/关系/方向歧义、规模与深度风险、过滤缺失、能力越界、合规与矛盾；软澄清为主，阻断仅在高风险。

里程碑与验收
- M1：跑通六类场景（含 dry-run 与 explain）；返回统一结构与透明记录；错误率≤1%；95% 响应时延满足目标（dry-run≤200ms/执行≤800ms，典型结果≤100节点）。
- M2：引入 Path/Aggregate/Set/RAG；完善排序与打分；Clarify 阈值与话术模板；鉴权与多租户。

文件与交付清单
- 《架构设计-系统与数据流.md》《模块设计-统一检索接口.md》《数据模型与索引设计.md》《场景流程设计.md》《澄清策略设计.md》《Hybrid检索与排序策略.md》《评估与监控.md》《部署与性能.md》。