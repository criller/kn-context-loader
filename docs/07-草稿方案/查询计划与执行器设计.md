# 查询计划与执行器设计（Intent Parser + Query Planner，v1）

目标与范围
- 聚焦核心环节：意图解析（Intents）与查询计划（Planner）。
- 保障 M1 关键场景稳定落地：实例检索、子图查询、关系/路径、属性获取、混合模式、澄清守护；为 M2 集合/聚合/Text/RAG 预留扩展位。

总体思路
- Parser：面向领域的结构化抽取 + 别名归一 + 置信度与歧义检测；混合模式支持在 NL 中承载结构化限定。
- Planner：能力驱动（capabilities.json）+ 代价/规模预估 + 守护/澄清/降级 + 多源路由与执行。
- 输出：统一 meta.plan（可干跑 dry_run），可解释、可监控、可复现。

一、Intent Parser 设计
1) 输入与输出
- 输入：mode=nl/exact/hybrid，nl_query.text，exact_query{concept/entity_id/filters, graph{relation_types,direction,depth}}。
- 输出（schema）：
  intent: {
    concepts: string[],
    entities: [{id?, name?, type?, confidence}],
    relations: string[],
    graph: { relation_types?, direction?, depth? },
    filters: [{ field, op, value, normalized?, source: 'nl'|'exact' }],
    aggregations?: [{ type: 'count'|'group_by'|'top_k', fields?, k? }],
    set_ops?: [{ type: 'intersect'|'union'|'diff', on: 'neighbors', of: string[] }],
    text_query?: { fields?: string[], keywords?: string[], semantic?: boolean },
    mode: 'nl'|'exact'|'hybrid',
    confidence: number,
    ambiguities?: [{ type, detail, candidates? }]
  }

2) 处理流程
- 预处理：语言检测、分句、正则/词典识别单位/时间（year/month）、数值与比较符号（> < ≥ ≤ 等）。
- 模式识别：若 exact_query 存在字段/graph，优先 exact；若 NL 中出现明显结构化限定，标记 hybrid。
- 别名归一（Aliases & TBox）：
  - 概念/关系/属性统一口径（企业/公司/单位→enterprise；专利状态→patent_status）。
  - 字段归一与映射，含中英文、缩写、俗称。
- 实体识别与链接（NER + EL）：
  - 词典/索引检索，支持别名、模糊；返回候选与得分。
  - 候选过多→ambiguities.push({ type:'entity_ambiguous', ... })。
- 关系与图参数抽取：
  - 关系类型（企业-专利、物料-反应等）、方向（out/in/both）、深度（默认=1）。
  - 路径/邻域关键词（“关联”“相邻”“多跳”“从…到…”等）。
- 过滤抽取：
  - 属性过滤（状态=授权；创建时间>=2022；Top-K=10 等）。
  - 操作符与单位统一（时间窗口近三年、数值单位归一）。
- 聚合/集合/Text：从 NL 识别 count/group/top-k/intersect/union/diff、文本字段与关键词。
- 置信度与歧义检测：
  - 规则与统计：命中率、覆盖度、冲突项数；LLM 抽取的一致性评分（可多次采样求一致）。
  - 触发软/阻断澄清的条件（见 Clarify）。

3) 方法与实现
- 组合式：规则/词典（TBox/Aliases）+ 模式模板 + LLM 结构化抽取（约束 JSON 模式）。
- 约束输出：通过 JSON Schema/正则校验，保证字段与取值合法。
- 自校验：抽取后进行 TBox 校验（概念/关系是否存在），失败项进入 ambiguities。
- 可配置：支持行业词汇的增量（化工/专利/园区等），日志记录抽取失败与回退路径。

4) Clarify 对接（简要）
- 当 ambiguities 非空或规模风险预估较高，生成 clarify.questions/candidates/suggestions。
- 软澄清：默认策略提示（如深度=1、limit=30、时间窗口=近三年）。
- 阻断澄清：例如实体候选过多、关系方向不明确且影响结果语义。

二、Query Planner 设计
1) Capabilities Registry（示例）
- capabilities.json（示例字段）：
  {
    "graph.expand": { "max_depth": 3, "max_nodes": 1000, "relation_types": ["enterprise-patent","material-reaction"] },
    "graph.exists": { "directions": ["out","in","both"] },
    "graph.path": { "shortest": true, "max_depth": 5 },
    "entity.search": { "fuzzy": true, "order_by": ["name","created_at"], "limit": 100 },
    "entity.attrs": { "fields": ["name","type","address","patent_status"], "secure": ["address"] },
    "text.search": { "semantic": true, "limit": 100 },
    "aggregation": { "count": true, "group_by": true, "top_k": true },
    "set.ops": { "intersect": true, "union": true, "diff": true }
  }

2) 计划模型（Operator 列表）
- OpEntitySearch(concept, filters, limit, order_by)
- OpGraphExpand(seed_entities, relation_types, direction, depth, limit)
- OpRelationExists(source, target, relation_types, direction)
- OpShortestPath(source, target, relation_types, max_depth)
- OpFilter(items, field, op, value)
- OpAggregation(items, type, fields?, k?)
- OpSetOp(neighbor_sets, type)
- OpTextSearch(fields, keywords, limit)
- OpJoin(left, right, strategy: by_id|field_equality|external_edge)
- OpDedup(items, by: ["id"|field])

3) 计划生成流程
- 校验与归一：对 Parser 输出进行 TBox/Capabilities 校验，修正默认值（direction、depth、limit、time_window）。
- 步骤编排：按场景映射选择 Operator 序列或小 DAG（先实体检索→邻域扩展→过滤/聚合→去重）。
- 规模/代价预估：
  - Cardinality 估计：基于能力声明的粗粒度统计与历史指标（如平均邻居度）。
  - 预算控制：设置执行超时/节点上限/早停规则。
- 守护/澄清/降级：
  - 超过阈值（深度>1、limit>50）→软澄清并先返回一跳；>2000 节点→阻断澄清或分步执行。
  - 能力越界（不支持的关系/操作）→返回替代建议或子图+客户端聚合。
- 多源路由：
  - GraphDB：图操作（expand/exists/path）。
  - RDBMS/Index：实体/属性检索、过滤与排序。
  - Vector/Text：RAG/语义检索（M2）。
- 重试与回退：
  - 失败策略：切换只读副本、降低并发、缩小范围（limit、时间窗口）。
  - 结果合并：统一去重与连接策略，保证输出口径一致。

4) 计划输出（meta.plan 示例）
- plan: [
  { op: "OpEntitySearch", args: { concept:"enterprise", filters:[{field:"name",op:"fuzzy",value:"爱数"}], limit:30 } },
  { op: "OpGraphExpand", args: { relation_types:["enterprise-patent"], direction:"out", depth:1, limit:50 } },
  { op: "OpFilter", args: { field:"patent_status", op:"=", value:"授权" } },
  { op: "OpDedup", args: { by:["id"] } }
]
- degeneration: [{ type:"limit", detail:"limit=50 to guard scale" }]
- defaults: { direction:"both", depth:1, time_window:"3y" }

三、示例（意图→计划）
1) NL："查看爱数的专利及其最近3年授权的数量Top-10"
- intent：concepts=[enterprise,patent]；entities=[爱数]；relations=[enterprise-patent]；filters=[patent_status=授权, time_window=3y]；aggregations=[top_k(k=10)]
- plan：OpEntitySearch → OpGraphExpand → OpFilter → OpAggregation(top_k)
- clarify：若匹配到多家“爱数”同名实体→返回候选并建议按地址/统一社会信用代码过滤。

2) Hybrid：nl="扩展园区X相邻企业的两跳子图"，exact.graph={ relation_types:["park-enterprise"], depth:2, direction:"both" }
- plan：OpEntitySearch(seed=园区X) → OpGraphExpand(depth=2,direction=both) → OpDedup
- guard：深度>1 触发软澄清；默认先返回一跳并提示“是否继续两跳”。

3) Exact：concept=material，filters=[{field:"hazard_level",op:">=",value:3}]，graph.depth=1
- plan：OpEntitySearch(material, filters) → OpGraphExpand(reaction/工艺关系) → OpFilter(hazard_level>=3)

四、M1 落地策略（分阶段）
- Sprint 1（2周）：
  - Parser：词典/别名归一，规则模板抽取（实体/关系/过滤/深度/方向）。
  - Planner：顺序计划 + 基础守护（depth=1, limit≤50, time_window=3y）。
  - Executors：Graph/Struct 适配器（一跳/属性/简单过滤）。
  - 观测：请求/计划/澄清/降级指标与日志、用例对齐。
- Sprint 2（2-3周）：
  - Parser：LLM 结构化抽取与一致性校验（few-shot + JSON Schema）。
  - Planner：规模/代价预估、重试与回退、缓存与 dry_run 计划可视化。
  - ClarifyEngine：软/阻断话术模板、候选生成与默认策略提示。
  - 评估：A/B、回归、典型场景采样与误差分析。

五、指标与评估
- Parser：抽取准确率、字段覆盖率、歧义触发率、澄清转化率、平均澄清轮次。
- Planner：计划成功率、守护触发率、降级率、P95 延迟、错误分类（能力越界/规模风险/后端失败）。
- 端到端：场景用例覆盖率、Top-K 准确性、子图规模控制、路径正确性。

六、风险与缓解
- 别名/口径不统一 → 强制 TBox/字段字典评审与增量维护；查询口径文档化。
- LLM 幻觉与不稳定 → 规则优先、LLM 受限输出、校验与一致性采样；必要时回退至规则。
- 规模爆炸 → 守护默认值、分步执行、早停与分页、提示过滤条件。
- 能力越界 → Planner 在计划阶段拦截并给出替代建议或降级。

七、与执行器的接口
- Executors 接口：execute(op, args, context) → { items, metrics, partial? }；支持重试与早停。
- 统一去重与连接策略：by_id（默认）/field_equality/external_edge；在 Formatter 合并输出。

八、与文档的对应
- 《模块设计-统一检索接口.md》：meta.plan、clarify、defaults/degeneration、错误码。
- 《架构设计-系统与数据流.md》：组件职责与数据/控制流、守护与降级策略。

备注
- 本设计为 v1，可基于评审补充更细的 JSON Schema 与算子参数约定，并在“capabilities.json”与“TBox/字段字典”对齐后固化实现。