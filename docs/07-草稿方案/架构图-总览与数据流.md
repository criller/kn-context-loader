# 架构图：总览与数据流（v1）

本文件用于直观看到“统一检索方案”的总体架构、请求生命周期和部署拓扑，便于评审与对齐。

一、逻辑架构总览（文本图）

Clients (Analyst UI / AI Agent)
    |
    v
[Query Gateway]
  - Auth / Rate Limit / Validation / Idempotency
    |
    v
[Intents & Planner]
  - Intent Parser (NL/Exact/Hybrid)
  - Query Planner (Capabilities-aware routing)
    |
    v
[Guardrails]
  - Limits / Defaults / Risk checks / Degeneration
    |
    v
[ClarifyEngine] <--> (Clarify Q&A with Client when triggered)
    |
    v
[Executors / Adapters]
  - Graph Executor (relations/subgraph)
  - Structured Executor (entity/attributes)
  - Text & Vector Executor (RAG, M2)
    |
    v
[Result Formatter]
  - Scene-shaped output / Minimal fields / Meta
    |
    v
Response (results + meta + clarify + error)

Side Services:
- Capabilities Registry (bottom interfaces & limits)
- Aliases & Synonyms (TBox / field normalization)
- Config (thresholds, defaults)
- Metrics & Logging (observability)
- Cache (hot intents & results)

下层数据源：GraphDB、Search Engine、RDBMS、Vector Index、Object Store

二、请求生命周期时序（文本时序）

1) Client → Gateway：提交请求（mode=nl/exact/hybrid，options/profile）。
2) Gateway：鉴权、限流、结构校验；按 profile 注入默认策略；命中缓存则直接返回。
3) Intent Parser：解析自然语言与结构化限定，归一化概念/关系/属性（Aliases/TBox）。
4) Query Planner：读取 capabilities.json，生成执行计划（步骤、路由、预估规模与代价）。
5) Guardrails：校验深度/limit/时间窗口等；必要时自动降级；存在歧义或高风险则触发 Clarify。
6) ClarifyEngine：生成问题、候选与建议；软澄清返回问题与默认建议；阻断澄清要求用户确认后再执行。
7) Executors/Adapters：按计划调用底层服务，遵守限额与早停；支持重试与回退；处理去重与合并。
8) Result Formatter：按场景生成最小字段集合；填充 meta（plan、metrics、intent、degeneration、defaults）。
9) Metrics/Logging：记录全链路指标与审计；异常统一错误码与建议。
10) Gateway：返回统一响应结构（results/clarify/meta/error）。

三、部署拓扑简图（文本图）

           +--------------------+
           |  Clients           |
           | (UI / AI Agent)    |
           +----------+---------+
                      |
                      v
         +------------+-------------+
         |   Query Gateway (N)     |
         |  Auth/Rate/Validation   |
         +------------+-------------+
                      |
              +-------+-------+
              |               |
              v               v
   +----------+-----+   +-----+----------+
   |  Planner/Parser|   | ClarifyEngine  |
   |   (scale out)  |   |  (scale out)   |
   +----------+-----+   +-----+----------+
              |               |
              +-------+-------+
                      |
                      v
         +------------+-------------+
         | Executors/Adapters (M)  |
         | Graph / Struct / Text   |
         +------------+-------------+
                      |
        +-------------+-----------------------------+
        |   Data Sources & Indexes                  |
        | GraphDB | Search | RDBMS | Vector | Obj  |
        +------------------------------------------+
                      |
        +-------------+-----------------------------+
        |  Side Services                            |
        | Capabilities | Aliases | Config | Cache   |
        | Metrics & Logging (centralized)           |
        +-------------------------------------------+

四、总体架构思路（摘要）
- 统一入口与统一输出：所有场景走同一接口与统一响应结构，包含最小字段集合与一致的 meta。
- 能力驱动与可扩展：Planner 基于 capabilities 的声明式路由；M2 能力通过新适配器与 Schema 扩展接入。
- 澄清与守护前置：规模守护与合规为第一优先；歧义与风险出现时以软/阻断澄清保障正确性与可控性。
- 混合模式优先：支持在自然语言中嵌入结构化限定，兼顾易用性与准确性。
- 可观测与可演进：全链路指标、日志与审计，便于灰度、A/B 与回归；能力、阈值与策略可配置。

五、与文档的对应关系
- 《方案总览.md》：目标、范围、能力矩阵、里程碑与验收标准。
- 《架构设计-系统与数据流.md》：组件职责、数据/控制流、守护与降级、部署与扩展性。
- 《模块设计-统一检索接口.md》：接口请求/响应/错误码与执行规则，场景映射。

备注：如需可视化图（Mermaid/PNG），我可以在此文件额外提供 Mermaid 版本并输出 PNG 以便评审展示。