# kn-context-loader 统一设计方案

---

## 第一章：愿景与目标 (Vision & Goals)

### 1.1 我们要解决什么问题？

在人工智能时代，通用大语言模型（Agent）作为“超级专家”，在面对企业内部的、私有的、结构化的业务知识时，存在三大核心痛点：

1.  **知识盲点 (Knowledge Gap)**：通用模型不具备企业内部的业务知识，无法回答相关问题。
2.  **产生幻觉 (Hallucination)**：在知识缺失的情况下，模型可能会“创造”看似合理但完全错误的答案。
3.  **上下文限制 (Context Limitation)**：无法将企业海量的业务数据一次性加载到模型的上下文中。

为了解决前两个痛点（知识盲点和幻觉），我们引入了**业务知识网络 (BKN)**。它以结构化的方式存储了我们企业所有的核心业务知识，是可靠的“事实源泉”。

然而，在我们将这个“事实源泉”与 Agent 连接时，Agent 的第三个痛点——**上下文限制**——就立刻成为了一个更加尖锐、无法回避的挑战。这个挑战与两者之间固有的语言障碍相结合，共同构成了一个全新的、核心的矛盾——**“认知与交互的鸿沟”**：

*   **Agent 对 BKN 是“盲人”**：Agent 不知道 BKN 中有哪些概念（TBox），也不知道具体有哪些实体（ABox）。它无法直接“看懂”这个知识库。
*   **BKN 对 Agent 是“哑巴”**：BKN 无法响应 Agent 基于自然语言的思考和意图，它听不懂“人话”。
*   **直接通信是“灾难”**：将整个知识库塞进 Agent 有限的上下文窗口，依然是不可行的。

因此，`kn-context-loader` 的诞生，正是为了解决这个核心矛盾。**它不是为了解决 Agent 或 BKN 各自的问题，而是为了解决当它们需要协同工作时，所产生的这个致命的“中间问题”**。它需要充当翻译官、导航员和数据优化师，让“思考者”和“事实库”能够真正高效地对话。

### 1.2 `kn-context-loader` 的核心使命

`kn-context-loader` 的核心使命，是充当**智能体 (Agent) 与业务知识网络 (BKN) 之间高效、智能的桥梁**。

### 1.3 业务知识网络是什么（仓库定义）

- 定义与分层：BKN 是用于描述业务领域的概念、属性、关系的知识表示模型，分为概念层（TBox）与数据层（ABox）（docs/01-概念约定/术语约定.md:3-5）。
- TBox 内容：对象类、关系类以及对象类属性的统一模型与示例结构（docs/01-概念约定/README.md:11-13；docs/01-概念约定/kn_tbox.json:2-13,18-26,28-45；docs/01-概念约定/kn_tbox.openapi.yaml:1-20,23-40）。
- ABox 内容：对象实例、关系实例与属性值的事实承载（docs/01-概念约定/术语约定.md:13-16），医疗示例展示了对象属性与条件操作符（docs/01-概念约定/医疗知识网络.json:13-31,31-39,60-67,90-117,156-180）。
- 能力视角：围绕 BKN 的核心操作能力包括实例检索、子图查询、关系确认、一跳属性获取、澄清；增强能力包括路径查询、聚合统计、集合运算、文本检索（docs/02-场景分析/1、基础能力说明.md:6-28）。

### 1.4 两层结构的要点与作用

- 概念层（TBox）：统一对象类与关系类的语义与连接约束，明确方向策略与连接策略（join_strategy、cardinality），为查询与集合构造提供规则基础（docs/02-场景分析/1、基础能力说明.md:36-46,58-74）。
- 数据层（ABox）：以业务数据实例承载事实，支持基于对象类型与条件操作符的筛选、分页与字段选择（api/ontology_query.yaml:8-12,57-99,151-169,170-195）。

它不是一个被动的数据提取工具，而是一个主动的“情报官”。它负责将 Agent 的“思考”转化为对知识网络的精确操作，并将获取的“事实”高效地提供给 Agent，作为其决策的依据。

### 1.3 设计原则

为达成使命，`kn-context-loader` 的所有设计都将遵循以下三大原则：

1.  **按需提供 (On-Demand Provisioning)**：绝不提供 Agent 不需要的信息。Agent 的每一次请求都应得到不多不少、恰到好处的响应。
2.  **渐进式认知 (Progressive Cognition)**：支持 Agent 从对知识网络的宏观概览，逐步深入到微观细节的探索过程，避免一次性加载大量无用信息。
3.  **效率优先 (Efficiency First)**：在接口设计和数据传输的每一个环节，都将优化 Token 消耗和减少通信次数作为核心指标。

---

## 第二章：核心场景与交互流程 (Core Scenarios & Interaction Flows)

为了具象化地理解系统各部分如何协同工作，本章将以一个贯穿全文的核心示例——“普通用户的健康咨询”——来详细拆解其端到端的交互流程。

### 2.1 场景描述

-   **用户 (小明)**: 一个对医学知识不了解的普通人。
-   **智能体 (Agent)**: 具备思考、规划和多轮提问能力的语言模型。
-   **kn-context-loader**: Agent 的“情报官”，连接着包含海量医学知识的业务知识网络 (BKN)。

### 2.2 交互流程详解

#### 2.2.1 第一轮交互：从模糊症状到主动提问

**1. 用户 -> Agent**
> “我最近不舒服，头晕、还咳嗽。”

**2. Agent 的思考与行动**
-   **分析**: 用户提供了两个模糊症状，信息不足，无法直接判断。
-   **规划**: 首要任务是将“头晕”和“咳嗽”这两个自然语言词汇，定位到 BKN 中的具体节点。
-   **工具调用**: 并行调用 `kn-context-loader` 的语义搜索接口。
    ```python
    tool_call_1 = kn_loader.explore(mode='abox_semantic', query='头晕')
    tool_call_2 = kn_loader.explore(mode='abox_semantic', query='咳嗽')
    ```
-   **情报分析**: Loader 返回了两个症状节点的 ID (`symptom_123`, `symptom_456`)。下一步是找出哪些疾病同时与这两个症状关联。
-   **工具调用**: 调用 `kn-context-loader` 的结构化查询接口。
    ```python
    tool_call_3 = kn_loader.query(
        mode='find_common_neighbors',
        source_nodes=['symptom_123', 'symptom_456'],
        target_type='疾病'
    )
    ```
-   **决策**: Loader 返回了多种可能的疾病（流感、肺炎、支气管炎）。信息依然不足以得出结论，必须向用户提问以获取更多区分性信息。

**3. Agent -> 用户**
> “根据您的症状，可能与流感、病毒性肺炎或支气管炎有关。为了帮助我更准确地判断，**请问您是否发烧？体温大概多少？**”

#### 2.2.2 第二轮交互：从补充信息到精准定位

**1. 用户 -> Agent**
> “是的，有点发烧，我量了一下，38.5度。”

**2. Agent 的思考与行动**
-   **分析**: 获得了关键的新证据：“发烧 38.5度”。
-   **规划**: 将“发烧”定位为 BKN 节点，然后用三个症状作为组合条件，重新筛选疾病。
-   **工具调用**: (经过类似第一轮的工具调用后) 最终的查询将三个症状节点的 ID 都包含在内。
-   **情报分析**: Loader 的返回结果被精确缩小为唯一的“流行性感冒”。任务转化为查询“流行性感冒”的解决方案。
-   **工具调用**: 调用 `kn-context-loader` 获取“流行性感冒”的推荐药物和建议检查。
    ```python
    tool_call_4 = kn_loader.get_neighbors(node_id='disease_01', relation='推荐药物')
    tool_call_5 = kn_loader.get_neighbors(node_id='disease_01', relation='建议检查')
    ```
-   **决策**: 信息充足，可以向用户提供一个完整的、包含诊断推断和解决方案的回复。

**3. Agent -> 用户**
> “综合来看，您的症状（头晕、咳嗽、发烧38.5度）高度符合‘流行性感冒’的特征。针对流感，通常有以下建议：
> *   **推荐药物**：例如‘奥司他韦’、‘连花清瘟胶囊’等。
> *   **建议检查**：可以考虑进行‘血常规’检查。
> 
> **重要提示**：以上仅为基于知识库的建议，不能替代执业医师的诊断。请务_必咨询医生。”

#### 2.2.3 第三轮交互：从追问到事实查询

**1. 用户 -> Agent**
> “奥司他韦是处方药吗？”

**2. Agent 的思考与行动**
-   **分析**: 这是一个关于“奥司他韦”实体的具体属性查询。
-   **规划**: 查询“奥司他韦”节点的`是否处方药`属性。
-   **工具调用**:
    ```python
    tool_call_6 = kn_loader.get_properties(node_name='奥司他韦', properties=['是否处方药'])
    ```
-   **决策**: 直接将查询到的事实返回给用户。

**3. Agent -> 用户**
> “是的，‘奥司他韦’是处方药，需要医生开具处方才能购买。”