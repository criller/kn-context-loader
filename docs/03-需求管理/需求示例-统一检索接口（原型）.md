# 需求示例：Data Agent 统一检索接口（原型）

## 1. 背景与目标
- 背景：业务知识网络已提供多类基础 HTTP 查询接口（实例检索、子图查询、实体搜索等）。AI/Data Agent 需要从这些接口按需检索数据，作为大模型的上下文。现阶段缺少统一且透明的“检索入口”，导致调用复杂、难以扩展与复用。
- 目标（SMART）：
  - 提供一个统一检索接口（支持 nl/exact/hybrid 三种模式），在 2 周内完成原型（M1）。
  - 响应包含 plan/explain/metrics，确保非黑盒、可调试与可复核。
  - 并发下（10 req/s），95 分位响应时延：dry-run ≤ 200ms、执行 ≤ 800ms（典型结果≤100节点）。
  - 对齐已有 `统一检索请求Schema.json` 与 `capabilities.json`，通过 6 个验收用例。

## 2. 用户故事 / 场景
- 场景 1（NL）：作为 Agent，我想用自然语言问“张三的工作单位是什么？”，系统能识别 Person/worksAt 与实体“张三”，生成并执行子图查询（depth=1），返回张三与公司A的关系边。
- 场景 2（Exact）：作为 Agent，当我知道概念与过滤条件（concept=Person, name=张三）时，我希望获取该实例及其指定关系子图（worksAt, depth=1），返回统一结构的 entities + subgraph。
- 场景 3（Hybrid）：作为 Agent，我以“张三的社交网络”为提示，并提供精确筛选（概念=Person, name=张三, relation_types=[knows, worksAt], depth=2），希望得到限定关系的子图。
- 场景 4（澄清）：当 NL 意图或实体识别置信度低时，系统应返回澄清问题与候选列表，避免误检索或大图爆炸。

## 3. 输入 / 输出
- 输入（统一封装，示例精简版）：
  - mode: nl / exact / hybrid
  - nl_query: { text }
  - exact_query: { concept/entity_id, filters[{field,op,value}], graph{depth,relation_types,direction} }
  - options: { limit, offset, order_by, response_format, explain, dry_run }
  - profile: precision / recall / balanced
- 输出（统一结构）：
  - results: { entities[], subgraph{nodes[], edges[]}, texts[] }
  - meta: { plan[], metrics{latency, calls, size}, intent/confidence, grounding{concepts/relations/entities} }

## 4. 约束与边界
- 技术约束：
  - 必须先有 `capabilities.json`（真实底层接口能力与限额），Planner 才可路由与校验；
  - max_depth、max_nodes、max_limit 等由 capabilities 限制；
  - options.timeout 生效；支持分页与游标（后续）。
- 业务边界（M1）：
  - 概念域先覆盖 Person/Company；关系先覆盖 worksAt/knows；
  - Path 查询、聚合统计延后至 M2；
  - 鉴权与多租户暂不纳入原型。

## 5. 非功能需求（NFR）
- 性能：见目标时延与并发要求；
- 可用性/容错：底层接口失败时返回统一错误结构（error.code/message/step/suggestion）；提供降级（降低 depth/limit）。
- 可扩展性：模块化（Planner/Adapters/Formatter/Validator），新增能力按 capabilities 注册即可接入。
- 透明与可解释：explain/dry_run 必须可用；plan 中包含 detail.url 与参数映射。

## 6. 成功标准 / 验收准则
- 用例列表（通过即验收）：
  1) NL：“张三的工作单位是什么？” → plan 命中 Person/worksAt → 执行返回张三→公司A 边；
  2) Exact：concept=Person, filters name=张三, graph depth=1 → 返回 person_123 实例与子图；
  3) Hybrid：nl=“张三的社交网络”，exact 筛选 relation_types=[knows,worksAt], depth=2 → 返回限定关系子图；
  4) Clarify：当识别到 Person 与 Customer 置信度接近时，返回澄清问题与概念候选列表；
  5) Dry-run：所有上述请求在 dry_run=true 时仅返回 plan/grounding/intent/confidence；
  6) 错误与降级：当 depth>cap.max_depth 时自动降级并在 explain 中记录，执行成功。
- 指标：
  - dry-run 95% 响应 ≤ 200ms；执行 95% 响应 ≤ 800ms（结果≤100节点）；
  - 错误率 ≤ 1%；澄清触发合理（不超过 15%）。

## 7. 里程碑与优先级
- M1（原型，P0）：
  - 完成 capabilities.json（真实）；
  - 跑通 nl/exact/hybrid 的 dry-run 与执行；
  - 实现 InstanceSearchAdapter/SubgraphAdapter；
  - 返回统一结果结构与 plan/metrics。
- M2（扩展，P1）：
  - 接入 EntitySearchAdapter；
  - Clarify 阈值与话术模板；
  - 排序与打分（bm25/embedding 混排）；
  - 增加 Path 与 Aggregate（可选）。

## 8. 相关文档与链接
- capabilities.sample.json（待替换真实）
- 统一检索请求Schema.json（请求校验）
- 统一检索示例请求.json（三种模式示例）
- 统一检索接口原型与场景分析.md
- 统一检索-Query Planner（NL模式）设计.md
- 统一检索-Query Planner（NL模式）解释说明.md
- 协作流程规范.md

## 9. 待办清单（TODO）
- [ ] 提供真实 `capabilities.json`，包含 instance/subgraph/entity 三类接口的 URL/方法/参数与限额；
- [ ] 对齐示例请求到真实参数，完成 dry-run 与执行验证；
- [ ] 增加 clarify 阈值与话术模板；
- [ ] 打通日志与 metrics 采集，观察召回规模与时延；