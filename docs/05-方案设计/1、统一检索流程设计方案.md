# 统一检索流程设计方案

## 文档目标

本文档旨在设计一套完整的业务知识网络检索流程，解决如何将用户的自然语言查询转换为对业务知识网络的检索。

## 一、问题定义与背景

### 1.1 业务知识网络的两层结构

根据术语约定，业务知识网络分为两层：

**概念层（TBox）**：
- 对象类：描述业务领域的实体类型（如企业、园区、专利）
- 关系类：描述对象类之间的关系类型（如企业_坐落在_园区）
- 对象属性：描述对象类的特征（如企业.名称、专利.申请日期）
- 关系映射：定义关系的连接策略、基数约束等

**数据层（ABox）**：
- 对象实例：具体的业务实体（如"爱数智慧科技有限公司"）
- 关系实例：具体的关系连接（如爱数智慧科技 坐落在 杭州高新区）
- 属性值：具体的属性数据（如企业名称="爱数智慧科技有限公司"）

### 1.2 检索的核心挑战

**本质问题**：如何将自然语言查询转换为对业务知识网络的精确访问？

#### 业务层面的核心挑战

**1. 多客户环境适配挑战**
- **问题描述**：产品需要在不同客户环境中部署，每个客户的业务场景、业务知识网络结构、术语体系都不相同
- **具体表现**：
  - 同一个词汇在不同客户环境不同的业务知识网络中可能指向不同的概念（如"厂家"在化工企业vs制造企业vs软件企业）
  - TBox结构差异导致关系类型、对象类型的定义不统一
  - 客户特有的业务术语和表达习惯
- **业务影响**：传统的规则库方法难以全面覆盖，维护成本极高

**2. AI Agent调用特性挑战**
- **问题描述**：统一检索主要服务于AI Agent调用，而非直接面向最终用户
- **具体表现**：
  - Agent的查询模式相对固定，但缺乏足够的历史数据进行规则总结和模型训练
  - Agent需要可解释的结果和多候选方案，而非单一答案
  - Agent具备一定的容错和二次决策能力
- **业务影响**：需要设计面向Agent的接口和响应格式，而非传统的用户友好界面

**3. 数据稀缺性挑战**
- **问题描述**：缺乏足够的用户查询数据来进行规则整理和模型训练，无法基于历史查询数据建立有效的意图识别规则
- **具体表现**：
  - 无法基于历史查询数据建立有效的意图识别规则
  - 难以预测和覆盖所有可能的查询模式
  - 新客户环境下的冷启动问题
- **业务影响**：必须采用自适应和动态推断的方法，而非依赖预训练模型

#### 技术层面的核心挑战

**1. 概念识别与映射**：如何从自然语言query中准确识别出相关的概念词汇，并映射到TBox中的对象类、关系类、属性？

**2. 意图理解与消歧**：用户的查询目的是什么？当存在多种可能解释时如何处理？

**3. 实体解析与绑定**：用户提到的实体名称如何与ABox中的具体实例关联？

**4. 约束提取与转换**：用户的限定条件如何转换为可执行的查询约束？

**5. 查询规模控制**：如何处理可能返回大量结果的查询，避免系统过载？

### 1.3 检索目标

**直接目标**：根据用户query，准确返回所需的数据实例和关系

**质量要求**：
- **准确性**：返回的结果符合用户真实意图
- **完整性**：不遗漏相关结果
- **可解释性**：用户能理解为什么返回这些结果
- **效率性**：响应时间满足业务要求

## 二、总体设计思路

### 2.1 核心理念

**"概念先行，意图驱动，渐进理解"**

基本思路：先获取相关概念，再进行多维度意图识别，最后执行查询

### 2.2 设计原则

1. **概念与意图分离**：先提取概念信息，再基于概念进行意图识别
2. **多维度意图识别**：场景目的、实体绑定、约束提取、辅助需求并行识别
3. **渐进式处理**：每个环节都有明确的输入输出，便于调试优化
4. **场景驱动**：基于10种核心场景设计处理逻辑
5. **ABox辅助**：必要时利用ABox信息完善理解

### 2.3 整体流程架构

```
Query输入 → 概念获取 → 意图识别 → 查询规划 → 执行格式化
    ↓           ↓           ↓           ↓           ↓
自然语言    TBox概念提取   多维意图理解   结构化计划   格式化结果
```

## 三、流程设计详述

### 3.1 阶段1：概念获取（Concept Extraction）

**目标**：从query中识别概念词汇，并从TBox中检索匹配的概念定义

**输入**：自然语言query
**输出**：TBox中匹配的概念信息

**核心任务**：
- 从query中提取候选概念词汇
- 在TBox的object_types和relation_types中检索匹配项
- 计算匹配的置信度
- **仅返回TBox中实际存在的概念定义**

**示例**：
```
输入："爱数企业在哪个园区，有多少专利"

输出：
{
  "matched_concepts": {
    "object_types": [
      {
        "mention": "企业",
        "matched_object_type": {
          "id": "enterprise",
          "name": "企业",
          "tags": ["企业信息", "厂家"],
          "confidence": 0.98
        }
      },
      {
        "mention": "园区",
        "matched_object_type": {
          "id": "park",
          "name": "园区",
          "tags": ["园区信息"],
          "confidence": 0.95
        }
      }
    ],
    "relation_types": [
      {
        "mention": "在",
        "matched_relation_type": {
          "id": "enterprise_2_park",
          "name": "坐落在",
          "tags": ["位于"],
          "source_object_type": "enterprise",
          "target_object_type": "park",
          "confidence": 0.85
        }
      }
    ]
  },
  "unmatched_terms": ["爱数"]
}
```

**说明**：
- 只返回在TBox中找到匹配的object_types和relation_types
- 未匹配的词汇（如实体名称"爱数"、查询指示词"多少"）放在unmatched_terms中，留给后续的意图识别阶段处理

### 3.2 阶段2：意图识别（Intent Recognition）

**目标**：基于概念匹配结果和未匹配词汇，识别用户的查询意图和场景类型

**设计原则**：
- **简单优先**：优先使用简单的模式匹配和TBox结构推断
- **渐进增强**：支持后续通过数据驱动的方式逐步优化
- **Agent友好**：输出格式便于AI Agent理解和处理
- **容错设计**：当不确定时提供多候选方案而非失败

**输入**：概念匹配结果 + 原始query
**输出**：意图识别结果（包含场景类型、实体绑定、查询指示等）

**核心处理逻辑**：

#### a) 场景类型识别
基于匹配到的概念组合，推断查询场景：

```json
{
  "scenario_identification": {
    "matched_concepts": ["enterprise", "park"],
    "inferred_scenario": "relation_query",
    "reasoning": "检测到两个对象类型，且存在连接关系enterprise_2_park",
    "confidence": 0.9,
    "alternative_scenarios": [
      {
        "scenario": "subgraph_query",
        "confidence": 0.6,
        "reasoning": "也可能是以enterprise为中心的邻域查询"
      }
    ]
  }
}
```

#### b) 实体识别与绑定
处理未匹配词汇中的实体，推断其对象类型：

```json
{
  "entity_binding": {
    "entity_mention": "爱数",
    "candidates": [
      {
        "inferred_type": "enterprise",
        "reasoning": "基于上下文'企业在园区'推断为企业实体",
        "confidence": 0.85,
        "binding_strategy": "context_inference"
      }
    ],
    "needs_abox_lookup": true,
    "lookup_strategy": "fuzzy_match_by_name"
  }
}
```

#### c) 查询指示词识别
识别查询的具体需求：

```json
{
  "query_intent": {
    "intent_type": "location_query",
    "target_info": "park",
    "query_pattern": "WHERE",
    "expected_output": "park_instances",
    "reasoning": "关键词'在哪个'表明查询位置信息"
  }
}
```

**完整示例输出**：
```json
{
  "intent_recognition": {
    "query": "爱数企业在哪个园区",
    "scenario_identification": {
      "primary_scenario": "relation_query",
      "confidence": 0.9,
      "reasoning": "检测到enterprise和park两个对象类型，存在enterprise_2_park关系"
    },
    "entity_binding": {
      "entity_mention": "爱数",
      "inferred_type": "enterprise",
      "confidence": 0.85,
      "needs_abox_lookup": true,
      "lookup_strategy": "fuzzy_match_by_name"
    },
    "query_intent": {
      "intent_type": "location_query",
      "target_info": "park",
      "query_pattern": "WHERE",
      "expected_output": "park_instances"
    },
    "next_step_guidance": {
      "recommended_action": "entity_resolution_then_relation_query",
      "required_abox_operations": ["find_enterprise_by_name"],
      "fallback_strategy": "return_all_enterprise_park_relations_if_ambiguous"
    }
  }
}
```

**设计特点**：
1. **简单直接**：基于TBox结构和简单模式匹配，避免复杂推理
2. **渐进优化**：为后续基于数据的优化预留空间
3. **Agent友好**：提供明确的next_step_guidance
4. **容错处理**：包含fallback_strategy处理不确定情况

### 3.3 阶段3：查询规划（Query Planning）

**目标**：将意图识别结果转换为可执行的查询计划

**输入**：意图识别结果
**输出**：结构化的查询执行计划

**核心任务**：
- 将业务意图转换为技术查询操作
- 生成查询步骤的执行序列
- 处理依赖关系和执行顺序
- 估算查询规模，触发守护机制

**示例**：
```json
{
  "query_plan": {
    "plan_id": "plan_001",
    "execution_strategy": "sequential_with_dependency",
    "steps": [
      {
        "step_id": 1,
        "step_type": "entity_resolution",
        "description": "解析'爱数'对应的企业实体",
        "operation": {
          "type": "fuzzy_search",
          "target_class": "enterprise",
          "search_field": "name",
          "query_value": "爱数",
          "max_candidates": 5
        },
        "output": "candidate_entities"
      },
      {
        "step_id": 2,
        "step_type": "relation_query",
        "description": "查询企业所在园区",
        "depends_on": ["step_1"],
        "operation": {
          "type": "find_relations",
          "source_entities": "${candidate_entities}",
          "relation_type": "enterprise_2_park",
          "direction": "outgoing"
        },
        "output": "park_relations"
      }
    ]
  }
}
```

### 3.4 阶段4：执行与获取（Execution）

**目标**：从ABox中执行查询并获取数据

**输入**：结构化的查询计划
**输出**：原始查询结果

**核心任务**：
- 按照查询计划的步骤顺序执行
- 路由到相应的执行器（ES、图数据库等）
- 处理步骤间的数据依赖
- 收集所有步骤的执行结果

### 3.5 阶段5：结果格式化（Result Formatting）

**目标**：根据意图对结果进行格式化输出

**输入**：原始查询结果 + 意图识别结果
**输出**：最终的用户友好结果

**核心任务**：
- 根据场景意图选择合适的输出格式
- 合并多个查询步骤的结果
- 生成可解释的结果说明
- 处理澄清和错误情况

## 四、支撑机制

### 4.1 澄清机制（Clarification）

**触发条件**：
- 实体置信度 < 0.7（实体歧义）
- 概念置信度 < 0.6（概念不明确）
- 查询结果规模 > 阈值（需要过滤条件）

**处理方式**：
- 生成澄清问题和选项
- 等待用户反馈
- 基于反馈更新查询计划

### 4.2 守护机制（Guardrails）

**规模控制**：
- 预估查询结果数量
- 超过阈值时要求添加过滤条件
- 实施分页和限制机制

**性能保护**：
- 复杂查询的超时控制
- 资源使用监控
- 降级策略

### 4.3 可解释性机制

**决策记录**：
- 记录每个阶段的处理依据
- 保存概念映射的匹配原因
- 追踪查询计划的生成逻辑

**结果解释**：
- 说明结果的来源路径
- 展示相关的概念和关系
- 提供置信度信息

## 五、关键技术方案

### 5.1 概念获取技术方案

#### a) 基于TBox概念词典
- 构建概念词典：对象类、关系类、属性的标准名称和同义词
- 支持模糊匹配和语义相似度计算
- 处理中文分词和实体识别

#### b) 语义相似度匹配
- 使用预训练语言模型计算语义相似度
- 支持概念的多种表达方式（同义词、别名）
- 设置置信度阈值过滤低质量匹配

#### c) 规则+机器学习组合
- 基于规则的精确匹配（高置信度）
- 基于ML的语义匹配（中等置信度）
- 人工标注数据训练领域特定模型

### 5.2 意图识别技术方案

#### a) 多分类器组合
- 场景分类器：识别10种核心查询场景
- 约束提取器：识别过滤条件和聚合操作
- 实体绑定器：将实体与属性进行关联

#### b) 基于模板的规则
- 预定义常见查询模式的模板
- 支持模板的组合和嵌套
- 动态生成新的查询模式

#### c) 上下文增强
- 利用对话历史增强意图理解
- 支持多轮对话中的指代消解
- 记忆用户的查询偏好

### 5.3 实体-属性映射技术方案

#### a) 模糊匹配算法
- 基于编辑距离的字符串匹配
- 支持拼音、简写等变体形式
- 处理OCR错误和输入错误

#### b) 语义匹配
- 使用实体嵌入进行语义匹配
- 支持上下文相关的实体消歧
- 利用知识图谱结构信息

#### c) 候选排序
- 综合字面匹配和语义匹配得分
- 考虑实体的重要性和流行度
- 支持用户反馈的在线学习

## 六、场景覆盖

基于场景分析文档，流程需要支持10种核心场景：

**M1阶段（6种）**：
1. 对象查询（Objects）
2. 关系查询（Relations）  
3. 路径查询（Paths）
4. 聚合统计（Aggregations）
5. 混合查询（Hybrid）
6. 推理查询（Reasoning）

**M2阶段（4种）**：
7. 时序查询（Temporal）
8. 空间查询（Spatial）
9. 多模态查询（Multi-modal）
10. 文本检索/RAG（Texts）

每种场景在意图识别阶段都有对应的识别逻辑和处理策略。

## 七、后续讨论重点

基于当前的流程设计，后续需要深入讨论的关键问题：

### 7.1 概念获取算法细节
- TBox概念词典的构建策略
- 语义相似度计算的具体算法
- 多语言和领域适配方案

### 7.2 意图识别的多维度处理
- 四个维度识别的优先级和依赖关系
- 复杂查询的意图分解策略
- 意图冲突的处理机制

### 7.3 实体-属性映射的准确性
- 模糊匹配的阈值设定
- 候选实体的排序算法
- 用户反馈的学习机制

### 7.4 澄清机制的触发条件
- 何时需要向用户澄清
- 澄清问题的生成策略
- 多轮对话的状态管理

### 7.5 查询规划的优化策略
- 复杂查询的分解和并行化
- 查询性能的预估和优化
- 守护机制的具体实现

这些问题的深入讨论将有助于将方案从概念设计转化为可实施的技术方案。

---

**文档状态**：初稿，待详细讨论和完善
**创建时间**：2025年
**版本**：v1.0