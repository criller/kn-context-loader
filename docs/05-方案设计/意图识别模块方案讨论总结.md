# 意图识别模块方案讨论总结

## 文档目的
- 总结意图识别模块在统一检索中的定位、职责与挑战的讨论结果，为后续方案设计与 M1 原型交付提供基础共识与实现参考。
- 本文档为方案讨论阶段的总结，尚未进入详细设计阶段。

## 模块定位与核心作用
- **位置**：位于"概念获取"与"查询规划"之间，充当语义路由器与安全守门人。
- **核心职能**：将 `query + 概念获取结果（matched_concepts, unmatched_terms）` 转换为"可执行的意图"。
- **意图定义**：不仅回答"想干什么"（场景），还要明确"对谁做""怎么做""返回什么"，并附带守护与澄清信息。
- **技术边界**：基于 TBox，将 NL 问句转换为"可执行且可解释"的意图包，不直接访问 ABox/底层数据源。

## 职责清单（标准流程）

### 1. 场景路由
- **目标**：将 NL 映射到 M1 场景（实例检索/子图/关系确认/属性获取/澄清/混合）
- **方法**：基于对象类组合、关系存在性、中文触发词（在哪/是否/包含/Top-N…）与方向词，确定主场景与备选
- **输出**：场景类型、置信度、备选场景

### 2. 实体绑定
- **目标**：为未匹配词做候选与置信判定
- **方法**：用字段优先级（`name > alias > code/id`）、模糊匹配（编辑距离/拼音/简写）
- **输出**：实体候选列表、绑定置信度、建议的解析操作

### 3. 约束提取
- **目标**：识别操作符并绑定到对象/关系属性
- **方法**：解析过滤与操作符（包含/等于/不等于/日期之后/Top-N/排序等），校验字段合法性与类型（来自 TBox 的 `data_properties`）
- **输出**：标准化约束条件，注明作用域（node/edge）

### 4. 图参数推断
- **目标**：确定图遍历参数
- **方法**：根据语义判定 `direction/depth/relation_types`（深度与关系类型受限于 `capabilities.json`）
- **输出**：{ direction, depth, relation_types }

### 5. 输出选择
- **目标**：确定期望返回的数据类型
- **方法**：问句模板决定输出类型（如"X的Y是什么"→`attributes`，"是否"→`relations.existence`，"有哪些/在哪个"→`instances`或`subgraph`）
- **输出**：`instances | relations | attributes | subgraph | texts` 之一

### 6. 置信与澄清
- **目标**：当概念/实体/场景低置信或规模风险时给出澄清问题与候选
- **方法**：置信度阈值判定 + 规模估算
- **输出**：澄清问题、候选选项、触发原因

### 7. 守护与降级
- **目标**：提前对 `depth/limit/节点规模` 做能力校验
- **方法**：依据 capabilities.json 对深度/节点数/limit 做前置校验；超限自动生成降级建议与解释
- **输出**：守护校验结果、降级建议与解释

### 8. 解释与指标
- **目标**：产出 reasoning 与规模估算，支撑 dry-run 与可复核
- **输出**：处理理由、默认值说明、规模/时延预估

## 输入与依赖
- **输入**：nl_text、matched_concepts/unmatched_terms（来自概念获取）、TBox 结构、对话上下文（可选）、capabilities.json（能力与限额）
- **依赖**：概念词典/同义词库（按租户注入）、数据属性类型表（TBox.data_properties）、方向/关系触发词

## 意图对象的语义构成（工程可直接消费）
- **scenario**：你要干什么（实例检索/子图/关系确认/属性获取/澄清/混合）
- **grounding**：你要对谁做（`concepts[]/relations[]/entity_candidates[]`）
- **constraints**：你怎么筛选与排序（操作符化、字段与作用域明确）
- **graph_params**：你怎么走（`direction/depth/relation_types`）
- **output_type**：你要返回什么（`instances/relations/attributes/subgraph/texts`）
- **confidence & clarify**：置信度、澄清问题与候选
- **plan_hints & guardrails**：执行建议、能力校验与降级项
- **explain & metrics_estimate**：理由、默认值与规模/时延预估

## 输出语义契约（字段形态可随方案调整）
```json
{
  "intent": {
    "scenario": "relation_query|instance_search|attributes_query|subgraph|clarify|hybrid",
    "confidence": 0.85,
    "reasoning": "基于触发词'在哪个'和对象类组合判定为关系查询",
    "target_types": ["enterprise", "park"],
    "output_type": "instances"
  },
  "grounding": {
    "concepts": [{"name": "企业", "type": "enterprise"}, {"name": "园区", "type": "park"}],
    "relations": [{"type": "enterprise_2_park", "direction": "out"}],
    "entity_candidates": [{"text": "企业A", "candidates": [...], "confidence": 0.9}]
  },
  "constraints": [
    {"field": "enterprise.name", "operator": "contains", "value": "A", "scope": "node"}
  ],
  "graph_params": {
    "direction": "out",
    "depth": 1,
    "relation_types": ["enterprise_2_park"]
  },
  "plan_hints": {
    "execution_order": ["entity_binding", "relation_query"],
    "guardrails": {"max_nodes": 1000, "estimated_nodes": 50}
  },
  "clarify": {
    "triggered": false,
    "questions": [],
    "options": [],
    "causes": []
  },
  "metrics_estimate": {
    "estimated_nodes": 50,
    "estimated_edges": 20,
    "limits": {"max_depth": 2, "max_nodes": 1000},
    "time_budget": "< 500ms"
  }
}
```

## 示例映射（规则模板如何工作）

### 示例1："企业A在哪个园区？"
```json
{
  "intent": {
    "scenario": "relation_query",
    "confidence": 0.9,
    "reasoning": "触发词'在哪个'+对象类组合'企业-园区'→关系查询",
    "target_types": ["enterprise", "park"],
    "output_type": "instances"
  },
  "grounding": {
    "concepts": [{"name": "企业", "type": "enterprise"}, {"name": "园区", "type": "park"}],
    "relations": [{"type": "enterprise_2_park", "direction": "out"}],
    "entity_candidates": [{"text": "企业A", "candidates": ["企业甲", "企业乙"], "confidence": 0.8}]
  },
  "graph_params": {"direction": "out", "depth": 1, "relation_types": ["enterprise_2_park"]},
  "plan_hints": {"execution_order": ["entity_binding", "relation_query"]}
}
```

### 示例2："企业A是否坐落在园区B？"
```json
{
  "intent": {
    "scenario": "relation_existence",
    "confidence": 0.95,
    "reasoning": "触发词'是否'+关系词'坐落在'→关系存在性确认",
    "output_type": "relations"
  },
  "grounding": {
    "entity_candidates": [
      {"text": "企业A", "candidates": ["企业甲"], "confidence": 0.9},
      {"text": "园区B", "candidates": ["园区乙"], "confidence": 0.85}
    ]
  }
}
```

### 示例3："企业A的注册地址是什么？"
```json
{
  "intent": {
    "scenario": "attributes_query",
    "confidence": 0.9,
    "reasoning": "触发词'是什么'+属性词'注册地址'→属性查询",
    "output_type": "attributes"
  },
  "grounding": {
    "concepts": [{"name": "企业", "type": "enterprise"}],
    "target_attributes": ["enterprise.registered_address"]
  }
}
```

## 能力边界与关键挑战

### 能力边界
- **不做什么**：
  - 不直接访问底层存储或产出最终查询结果
  - 不进行复杂路径推理和聚合统计
  - 不引入重模型依赖（M1阶段）
  - 不处理跨租户的概念映射

### 关键挑战
1. **多客户术语差异**：同一概念在不同客户处的表达方式差异巨大
2. **实体同名歧义**：同名实体在不同上下文中的指代不明
3. **中文问句多样化**：同一意图的多种表达方式，语序灵活
4. **规模爆炸风险**：深度遍历和大规模实体集合的性能问题
5. **能力对齐**：意图识别结果与实际执行能力的匹配度
6. **数据稀缺**：缺乏足够的标注数据进行模型训练

## M1阶段技术方案（可落地、可扩展）

### 1. 场景路由：规则表 + 打分器
- **规则表**：基于触发词组合的场景映射表
- **打分器**：多维度评分（触发词匹配度、对象类组合、关系存在性）
- **实现**：中文规则模板库 + 权重配置

### 2. 实体绑定：字段优先级 + 模糊匹配
- **字段优先级**：`name > alias > code/id > description`
- **模糊匹配算法**：编辑距离 + 拼音相似度 + 简写匹配
- **置信度计算**：匹配度 × 字段权重 × 频次权重

### 3. 约束提取：操作符表 + 模板匹配
- **操作符表**：中文表达 → 标准操作符的映射
- **模板匹配**：基于词性标注和依存分析的约束识别
- **类型校验**：基于 TBox 的字段类型验证

### 4. 输出选择：模板映射 + 默认策略
- **模板映射**：问句模式 → 输出类型的规则表
- **默认策略**：当模板匹配失败时的降级选择

### 5. 守护与降级：能力联动 + 阈值控制
- **能力联动**：与 `capabilities.json` 的实时校验
- **阈值控制**：深度、节点数、时间预算的多层防护
- **降级策略**：自动调整参数或建议替代方案

### 6. 置信与澄清：阈值建议 + 模板生成
- **阈值建议**：
  - 概念匹配：< 0.7 触发澄清
  - 实体绑定：< 0.6 触发澄清
  - 场景置信度：< 0.8 触发澄清
- **澄清模板**：基于失败原因的问题生成模板

## M1阶段验收标准
1. **场景覆盖**：支持六类基础场景的用例覆盖
2. **澄清触发率**：合理的澄清触发率（10-20%）
3. **规模守护**：大规模查询的有效拦截与降级
4. **降级透明**：降级决策的完整记录与解释
5. **响应时间**：意图识别阶段 < 200ms

## 风险与对策
1. **规模爆炸** → 多层阈值防护 + 预估算法
2. **术语差异** → 租户级词典 + 动态学习机制
3. **歧义处理** → 上下文记忆 + 澄清策略
4. **性能瓶颈** → 缓存策略 + 异步处理

## 后续工作（进入设计阶段）
1. **规则模板库设计**：详细的中文规则模板清单与场景打分要素
2. **实体绑定算法**：字段优先级表与模糊匹配算法实现
3. **能力接口对接**：与真实 `capabilities.json` 的集成方案
4. **原型验证**：完成一版 dry-run 输出样例与验证
5. **性能优化**：缓存策略与并发处理方案
6. **扩展性设计**：为 M2 阶段的模型增强预留接口

---

**注**：本文档为方案讨论阶段的总结，后续将基于此共识进入详细的技术设计与实现阶段。

## 职责清单按场景调整（M1指南）
- 实例检索（Entity Lookup）
  - 必做：场景路由、实体绑定（对象类型判定）、约束提取（字段过滤/排序/Top-K）、输出选择
  - 可选：图参数（一般不需要）、守护与澄清（规模/同名歧义）
- 子图查询（Neighborhood/Expand）
  - 必做：场景路由、实体绑定（种子实体）、图参数（direction/depth/relation_types）、约束提取（节点属性过滤）
  - 必做：输出选择（subgraph）、守护与澄清（深度/方向/类型选择）
- 关系确认（一跳 Relation）
  - 必做：场景路由、实体绑定（源/目的）、图参数（relation_types、direction、depth=1）
  - 必做：输出选择（relations 或 existence）、守护与澄清（关系类型/方向）
- 属性获取（Attribute Fetch）
  - 必做：场景路由、实体绑定（对象类型与目标实体）、约束提取（字段名归一、最新值/状态等）
  - 必做：输出选择（attributes）、守护与澄清（缺失或别名不一致）
- 澄清（Clarify）
  - 必做：澄清模板生成（对象类型/关系类型/方向/深度/limit/连接键/去重口径）
  - 必做：守护与降级建议（透明记录影响与默认策略）
- 混合模式（Hybrid）
  - 必做：在结构化限定范围内组合基本场景（实例/子图/属性），并输出组合结果结构
  - 必做：对超出能力的限定给出澄清或降级

## M1场景规范·实例检索（讨论与共识）

- 场景目标：通过名称/别名/类型/属性筛选，定位对象实体，用作确认与后续分析起点。

- 意图输出结论（当前共识 v0.1）
  - scenario：`instance_search`
  - output_type：`instances`
  - grounding：`concepts[{type}]`（至少指定对象类型）；`entity_candidates[]`（当涉及具体名称提及时可选）
  - constraints：`filters[{field,operator,value}]`、`sort[{field, order}]`、`top_k|limit`、`pagination{limit,offset}`
  - plan_hints：`order_by: relevance|time`（默认 `relevance`）、`limit: 20`（最大 `100`）
  - clarify 触发：同名歧义/多候选、缺少对象类型、过滤字段无效或规模风险（给出问题/选项/默认）

- 意图对象契约（Schema v0.1）
```json
{
  "intent": {
    "scenario": "instance_search",
    "confidence": 0.85,
    "target_types": ["enterprise"],
    "output_type": "instances"
  },
  "grounding": {
    "concepts": [{"type": "enterprise"}],
    "entity_candidates": [{"text": "华化", "confidence": 0.7}]
  },
  "constraints": [
    {"field": "enterprise.name", "operator": "contains", "value": "化工"},
    {"field": "enterprise.status", "operator": "=", "value": "在营"}
  ],
  "plan_hints": {
    "order_by": "relevance",
    "pagination": {"limit": 20, "offset": 0}
  },
  "clarify": {
    "triggered": false,
    "questions": [],
    "options": [],
    "causes": []
  }
}
```

- 用例驱动示例（对齐《02-场景-实例检索.md》）
  1) 名称包含："查找名称包含‘化工’的企业" → `enterprise.name contains '化工'`，返回 `instances`
  2) 按属性筛选："危化品类别为易燃液体的物料有哪些？" → `material.hazard_class = 易燃液体`，返回 `instances`

- 决策快照（待你确认/修订）
  - 默认 `limit=20`，上限 `100`；默认排序 `relevance`，可选 `time desc`
  - 返回字段最小集：`id|type|name`；可选 `primary_fields`（如 address, status）
  - `matched_fields[]` 作为可选返回，用于解释命中理由
  - 允许同时指定多个对象类型（如 enterprise|park），但当结果规模过大时触发澄清

- 未决项（待讨论）
  - 是否将 `matched_fields[]` 升级为必选？
  - 是否需要返回 `synonyms[]`（归一化别名）以便客户端展示？
  - 多类型检索的默认排序策略与分页口径？
  - 是否需要返回 `total_count`（若有分页）与 `has_more`？

## M1维度视图·实例检索（识别要点与示例映射）

- 维度总览（与你的理解对齐，并补充必需维度）
  1) 对象类型识别（target_types）：从query中识别检索的对象类型（enterprise/park/patent/material/process/reaction）。
  2) 约束条件识别（filters）：精确（=）、模糊（contains/startswith/endswith）、范围（>/</between）、集合（in）、空值（is null）、负过滤（!=）；M1默认多条件AND组合，OR需明确表达或进入澄清。
  3) 排序识别（sort）：默认 `relevance`；当出现时间指示词或日期字段时支持 `time desc`（例如 `patent.grant_date`、`process.updated_at`）。
  4) 分页/limit识别（pagination/top_k）：`limit`（默认20，上限100）、`offset`；"只看Top50"→`limit=50`。
  5) 命中解释（matched_fields，可选）：返回命中字段与理由，增强可解释性（建议在有过滤/排序时返回）。
  6) 字段与别名归一（field_aliases/synonyms，可选）：将术语/别名映射到TBox字段，统一如 `patent.number↔专利号`、`material.cas_no↔CAS`、企业简称/别名归一。
  7) 规模守护与澄清（clarify）：同名歧义、缺失对象类型、过滤字段无效、结果规模过大时触发澄清（问题/选项/默认），避免不可控返回。

- 约束条件细分（M1支持口径）
  - 等值/不等：`field = value`、`field != value`
  - 模糊：`contains`、`startswith`、`endswith`
  - 集合：`field in [v1,v2,...]`
  - 范围：`field between [min,max]`、`>=`、`<=`
  - 空值：`field is null` / `field not null`
  - 组合：M1统一按 AND 组合；出现 OR/复杂表达时建议澄清或降级。

- 示例类别→维度映射（与“示例覆盖清单·实例检索”对应）
  1) 名称/别名：`filters.name contains/equals`；`sort: relevance`；`limit:默认`；必要时`synonyms`、`clarify`（同名歧义）。
  2) 类型驱动：`target_types=[enterprise|park|...]`；若无属性约束且规模超限→`clarify`或强制`limit`。
  3) 属性过滤：精确/模糊/集合/范围/空值均映射为`filters[]`；如 `patent.ipc contains C07D`、`material.cas_no = 64-17-5`。
  4) 时间与状态：日期字段→`filters[grant_date >= ...]`；排序可识别为 `time desc`；状态字段→`filters.status = 在营`。
  5) 编号/业务键：如 `enterprise.credit_code = ...`、`patent.number = ...`；排序默认为 `relevance`。
  6) 多条件组合：多条 `filters[]`（AND）；若出现 OR→`clarify`。
  7) 多类型检索：`target_types` 多值；规模守护与`clarify`必备；排序 `relevance`。
  8) 负过滤：`filters.status != 已注销`；与其它条件按 AND 组合。
  9) 排序与分页：如“前50条、按时间倒序”→`limit=50`、`sort: time desc`；可含`offset`与`has_more`。
  10) 歧义/澄清触发：类型缺失、多候选、过滤字段无效、规模风险→`clarify.questions/options/defaults`。

- 验收要点（M1维度识别）
  - 能稳定识别 4 个核心维度：`target_types`、`filters`、`sort`、`limit/pagination`。
  - 针对示例清单的覆盖集，维度识别准确率≥95%；当不确定/超口径能触发澄清。
  - 有过滤或排序时，建议返回 `matched_fields[]` 提升解释性（可选）。

- 未决项（待拍板）
  - OR 组合是否纳入M1（建议：不纳入，改澄清）。
  - `matched_fields[]` 默认是否返回（建议：有过滤/排序时默认返回）。
  - 是否统一返回 `total_count` 与 `has_more`（建议：当分页启用时返回）。
  - `synonyms[]` 是否纳入默认返回（建议：不默认，仅在名称/别名冲突时返回）。

## M1扩展·多实例/批量检索（并列查询）

- 场景动机
  - 单句query并列提出多个实例诉求：按名称列举（企业A、企业B）、多对象类型并列（企业与园区）、或不同过滤口径并列（企业名称含X、专利标题含Y）。
  - 目标是在“实例检索”范畴内支持并列查询，而不跨入关系/子图能力（跨关系的并列请进入“子图/混合模式”）。

- 典型表达（示例）
  - 列举名称并检索：“查企业A、企业B的基本信息”。
  - 多类型并列：“查名称含‘新能源’的企业和园区（各取前50条）”。
  - 多口径并列：“查名称含‘化工’的企业，同时查标题含‘乙醇’的专利”。
  - 批量业务键：“按名单里公司名（企业A/企业B/企业C）逐一检索并返回地址”。

- 识别与输出（对实例检索契约的扩展建议，不拍板）
  - 对象类型：`target_types` 允许多值，或按分组表示不同类型的并列段。
  - 并列实体枚举：`entity_list[{text,type?}]`；用于逐名检索（如企业A/企业B）。
  - 分组约束：`grouped_filters[{group_id, target_type, filters[], sort?, pagination?}]`，分别定义每个并列段的条件与规模。
  - 结果分组：`grouping{by: type|group_id}`；返回 `groups[{group_id, nodes[]}]`，便于前端分区展示。
  - 命中解释：各组返回 `matched_fields[]`；保留 `not_found[]`（输入枚举中未命中者）与 `partial_success: boolean`。
  - 去重策略：`dedup{by: id|fields, fields?:[]}`，用于批量枚举或多类型并列的交叉重复。
  - 规模与分页：支持 `per_group.limit` 与全局 `limit_total`；当未指定时应用默认限制与澄清。
  - 风险与澄清：当某组规模过大或字段无效时，`clarify` 给出组级问题与默认值建议。

- 示例（并列枚举 + 多类型）
```json
{
  "intent": {"scenario": "instance_search", "output_type": "instances"},
  "grounding": {
    "target_types": ["enterprise", "park"],
    "entity_list": [
      {"text": "企业A", "type": "enterprise"},
      {"text": "企业B", "type": "enterprise"}
    ]
  },
  "grouped_filters": [
    {"group_id": "g1", "target_type": "enterprise", "filters": [{"field": "enterprise.name", "operator": "contains", "value": "新能源"}], "pagination": {"limit": 50}},
    {"group_id": "g2", "target_type": "park", "filters": [{"field": "park.name", "operator": "contains", "value": "新能源"}], "pagination": {"limit": 50}}
  ],
  "grouping": {"by": "group_id"},
  "plan_hints": {"dedup": {"by": "id"}},
  "clarify": {"triggered": false}
}
```

- 示例（批量业务键 + 组结果）
```json
{
  "intent": {"scenario": "instance_search", "output_type": "instances"},
  "grounding": {
    "target_types": ["enterprise"],
    "entity_list": [
      {"text": "华化公司"},
      {"text": "中化集团"},
      {"text": "XX化工"}
    ]
  },
  "grouped_filters": [{"group_id": "g_enterprise", "target_type": "enterprise", "filters": [], "pagination": {"limit": 20}}],
  "grouping": {"by": "type"},
  "return_fields": {"primary_fields": ["enterprise.address", "enterprise.brirf_info"]},
  "outputs": {
    "groups": [
      {"group_id": "g_enterprise", "nodes": [{"id": "E001", "type": "enterprise", "name": "华化公司"}]}
    ],
    "not_found": [{"text": "XX化工", "reason": "未命中或低置信"}],
    "partial_success": true
  }
}
```

- 未决项（待拍板）
  - 并列段的表达是否采用 `grouped_filters`（推荐）还是简单 `target_types` + 多 `filters[]`？
  - `entity_list` 是否纳入实例检索契约（仅在枚举场景下出现）？
  - 分页口径：默认采用组级分页（per_group），是否还需要全局 `limit_total`？
  - 结果分组返回结构的最小集：是否统一采用 `groups[{group_id,nodes[]}]`？
  - `not_found[]` 与 `partial_success` 是否作为默认字段返回？

## M1选型与实施计划·混合方案（规则 + 小模型抽取 + LLM兜底）

- 实施目标
  - 以最低成本与稳定一致性，覆盖实例检索的主流与长尾表达；所有输出统一落到“意图契约Schema v0.1.x”。
  - 保证可解释与可控：规则优先、高置信；小模型补充结构化抽取；LLM仅在复杂/低置信场景兜底。

- 整体架构（模块）
  - `orchestrator`：编排管线与门控，聚合置信、决定路由、拼装契约、触发澄清。
  - `preprocessor`：规范化（数字/时间/单位/别名）、分词与短语识别、句法/并列分段。
  - `scenario_classifier`：场景分类（`instance_search` 等），规则+小模型融合。
  - `type_detector`：对象类型识别与归一（贴合 TBox），含 `entity_list[]` 枚举检测。
  - `constraint_extractor`：抽取 `filters[]`（精确/模糊/范围/组合），含字段映射与运算符。
  - `group_builder`：并列/批量识别，生成 `grouped_filters[]` 与 `grouping.by`。
  - `sort_pagination_parser`：解析 `sort` 与 `pagination`（组级与全局）。
  - `contract_generator`：产出标准契约（`intent/grounding/constraints/plan_hints/clarify`）。
  - `validator_guardrails`：`jsonschema` 校验、TBox对齐、规模与安全守护（`limit`、字段白/黑名单）。
  - `clarify_manager`：澄清触发与问题模板（规模过大、条件含糊、字段不可用）。
  - `llm_adapter`：函数式/JSON 输出的 LLM 兜底，使用少样本与工具化检索增强。

- 处理管线（M1）
  1) 预处理：统一数字/时间表达，归一别名/同义词（贴合 TBox），识别并列枚举（逗号/顿号/“和”）。
  2) 场景分类：
     - 规则命中（高置信）：固定短语/模板直出 `scenario`。
     - 小模型（BERT/SVM）补充；置信>0.8 采纳，否则进入下游兜底。
  3) 类型识别：
     - 规则词典映射到 `grounding.target_types[]`；枚举文本进入 `entity_list[]`。
     - 小模型 NER/多标签识别；低置信时请求 LLM 归一（带 TBox 列表约束）。
  4) 约束抽取：
     - 规则解析精确/模糊/范围；字段名映射到 TBox 字段（`enterprise.name` 等）。
     - 小模型序列标注/抽取（Span/MRC）；复杂组合或冲突交给 LLM 合并为 `filters[]`。
  5) 并列/批量：
     - 通过分段规则与枚举检测生成 `grouped_filters[{group_id,target_type,filters,sort?,pagination?}]`。
     - 设置 `grouping.by=group_id|type`，并可选 `plan_hints.dedup` 去重。
  6) 排序与分页：解析时间倒序、相关性；默认组级 `limit`，可选全局 `limit_total`。
  7) 契约生成：
     - 汇总为 `intent/grounding/constraints/grouped_filters/grouping/sort/pagination/plan_hints/clarify`。
     - 当用户要求字段，填充 `return_fields.primary_fields[]`。
  8) 校验与守护：
     - `jsonschema` 校验（类型/枚举/必填/可选）；TBox 字段合法性检查；规模阈值（如 `limit<=200`）。
     - 不合法→自动修正或触发 `clarify`（附默认建议）。
  9) 输出与解释：
     - 存在过滤/排序时默认返回 `matched_fields[]`；并列/批量启用时返回 `groups[]`、`not_found[]`（如有）、`partial_success`。

- 门控与置信融合
  - 置信来源：规则（1.0/0.9）、小模型（概率）、LLM（自报置信或温度校正）。
  - 决策：
    - `score>=0.8` → 接受当前层输出；`0.5<=score<0.8` → 下一层补充/校正；`<0.5` → 直接交给 LLM。
  - 复杂度触发：出现 OR/多段并列/跨类型多组/字段冲突时优先调用 LLM 合并结构。

- LLM 兜底设计
  - 以“函数式输出”约束 LLM：提供 `意图契约Schema v0.1.x` 的 JSON 结构作为函数签名。
  - Few-shot 示例覆盖：单实例、并列/批量、时间范围、排序、分页、字段请求。
  - RAG增强：向 LLM 提供 TBox 类型/字段/同义词的检索接口，减少幻觉与字段错配。
  - 后处理：严格 `jsonschema` 验证，删除未知字段、纠正枚举值，必要时触发澄清。

- 数据与模型选型（M1）
  - 规则资源：场景关键短语表、类型/字段词典、别名/同义词表、运算符模板（精确/模糊/范围）。
  - 小模型：
    - 场景分类：中文 BERT 微调或传统 ML（SVM/GBDT），目标>0.9 准确率（核心用例）。
    - 序列标注/抽取：BiLSTM-CRF 或 BERT-Span；覆盖字段值、范围边界、运算符。
    - NER：企业/园区/专利/物料等专名识别（可共用抽取模型）。
  - LLM：支持函数调用/结构化 JSON 输出；配合 RAG 与校验器使用。

- 校验器与澄清策略（M1默认）
  - 校验：
    - `target_types` 必须在 TBox；字段必须在对应类型定义；分页字段合法；组合逻辑不冲突。
  - 澄清触发：
    - `limit` 缺失且命中规模可能>默认阈值；范围边界缺失；字段不可用；并列组条件过宽。
  - 澄清输出：问题 + 默认建议（如每组 `limit=50`、按时间倒序）。

- 成本与性能守护
  - LLM仅在门控触发时调用；缓存热门查询的契约；对等价重复请求复用结果。
  - 统计并优化：LLM调用率、平均延迟、失败率；离线回归集覆盖率。

- 评估与回归（M1验收指标）
  - 场景准确率、槽位抽取 F1、契约有效率（通过校验器占比）。
  - 澄清触发准确率、并列/批量识别召回率；LLM调用率与成本占比。
  - 回归集：核心用例 + 并列/批量 + 时间/范围/排序/分页；每次变更自动跑。

- 里程碑与拍板点
  - M1：三维识别（约束/排序/分页）+ 并列/批量（`grouped_filters`）+ 解释（`matched_fields`）+ 基本澄清。
  - M1未决拍板：OR组合表达、`synonyms[]` 默认返回、`total_count/has_more` 默认返回策略。
  - M1.1：补充 OR 组合的契约与解析；拓展字段与复杂排序；优化门控阈值。

## M1紧急落地·LLM双层替代（无规则/无数据）

- 目标
  - 在缺少规则与标注数据的情况下，快速上线 MVP：用“轻参数 LLM”替代小模型抽取，用“重参数 LLM”替代复杂兜底，产出统一契约（Schema v0.1.x）。

- 架构
  - `orchestrator`：编排轻/重 LLM 调用与门控，汇总输出为契约。
  - `llm_light`：小参数 LLM（如 7B/13B）做场景分类、类型识别、槽位抽取（filters/sort/pagination/entity_list）。
  - `llm_heavy`：大参数 LLM（如 GPT-4 级别）处理并列/批量、OR 组合、跨类型多组、冲突合并与澄清建议。
  - `validator_guardrails`：`jsonschema` 校验与 TBox 对齐、规模守护；`clarify_manager` 生成澄清。

- 轻 LLM（职责与接口）
  - 输入：原始 query + TBox 类型/字段枚举（通过 RAG/词典注入）。
  - 输出：结构化 JSON（函数式），包含 `scenario`、`grounding.target_types/entity_list?`、`constraints.filters`、`sort`、`pagination`。
  - 适用：简单/中等复杂度（单组、少量过滤、常见排序与分页）。
  - 置信：返回自报置信或由规则化评分（短句、无并列、字段在白名单）。

- 重 LLM（职责与接口）
  - 输入：轻 LLM 的初步结构 + 原始 query + TBox 枚举。
  - 输出：合并/校正后的完整契约，支持 `grouped_filters[]`、`grouping.by`、`plan_hints.dedup`、澄清建议与解释字段（`matched_fields[]`）。
  - 适用：并列/批量、多组、OR 组合、冲突字段或长句复杂表达。

- 门控与触发
  - 触发重 LLM 的启发式：
    - 发现并列标记（逗号/顿号/“和”）或多类型并列；
    - 出现 OR/跨字段复杂组合；
    - 字段不在 TBox、范围/单位不一致、分页缺失且可能超规模；
    - 轻 LLM 低置信（如 <0.7）或结构不完整（缺关键槽位）。

- 提示与 RAG
  - 函数式/JSON 输出：将 Schema v0.1.x 作为函数签名，限定返回结构。
  - Few-shot：覆盖单实例、并列/批量、时间范围、排序、分页、字段诉求示例。
  - RAG：向两层 LLM提供 TBox 的 `types/fields/synonyms` 检索，降低幻觉与错映射。

- 契约与后处理
  - 契约统一：`intent/grounding/constraints/grouped_filters/grouping/sort/pagination/plan_hints/clarify`。
  - 校验：`jsonschema` 强校验；枚举纠错；字段白/黑名单；规模阈值（如 `limit<=200`）。
  - 澄清：当规模/边界/字段不合理时，生成问题与默认建议（如每组 `limit=50`、时间倒序）。

- 成本守护
  - 轻 LLM 优先、重 LLM 按需触发；缓存热门契约；限制最大 tokens 与温度；记录与复用重复请求。

- 验收用例（MVP）
  - 三维识别：约束（精确/模糊/范围/组合）、排序（时间倒序等）、分页（`limit/offset`）。
  - 并列/批量：`grouped_filters` 两组以上、按 `grouping.by` 返回；支持 `not_found[]` 与 `partial_success`。
  - 解释：存在过滤/排序时返回 `matched_fields[]`；分页启用返回 `has_more/total_count`（可选）。

- 选型建议
  - 轻 LLM：中文 7B–13B 系（如 Qwen2-7B/13B、Mistral-7B、Llama-3.1-8B）或同等托管小模型。
  - 重 LLM：GPT-4 系、Qwen2-72B 或企业内高性能大模型，支持函数式输出。

- 落地步骤（两周）
  1) 契约 `jsonschema` 与 TBox 注册（读取 `01-概念约定/kn_tbox.json`）。
  2) 提示与函数签名：轻/重两套；接入 RAG 提供类型/字段/同义词枚举。
  3) 封装调用：`llm_light` 与 `llm_heavy` 的统一接口、重试与缓存。
  4) 门控实现：基于启发式与轻 LLM 置信的触发规则。
  5) 后处理与澄清：校验、纠错、澄清生成与默认建议。
  6) 用例回归：选 30–50 条核心用例（单实例+并列/批量+时间/排序/分页）对齐验收。

- 未来演进
 - 有数据后：逐步加入规则（高频模板）与小模型（分类/抽取），降低成本与延迟；保留重 LLM 兜底。

## 意图识别输出模板（标准版 v0.2.0 与紧凑版 c0.2）

> 目标：提供“可执行且可扩展”的统一意图契约（标准版）与“低 token 输出”的紧凑版（Codebook），覆盖 M1 所有场景，并为后续扩展（聚合/集合/路径/文本RAG）预留槽位与版本化机制。

### 标准版 Schema v0.2.0（覆盖所有场景）

- 场景枚举：`instance_search | attributes_fetch | relation_query | relation_existence | path_query | subgraph | aggregation | set_ops | text_rag | clarify | hybrid`
- 字段总览：
  - `intent`: { `scenario`, `output_type`, `confidence`, `reasoning`, `target_types?` }
  - `grounding`: { `concepts[]`, `entity_list[]`, `entity_candidates[]`, `relations[]`, `target_attributes[]` }
  - `constraints`: { `filters[]`, `sort[]`, `pagination{limit,offset}`, `groups[]`, `dedup?`, `set_ops?`, `aggregation?` }
  - `graph_params`: { `direction`, `depth`, `relation_types[]`, `path{source_ids?, target_types?, max_hops?, allowed_relations?, allowed_types?}` }
  - `rag_params?`: { `corpora[]`, `top_k`, `rerank` }
  - `plan_hints?`: { `execution_order[]`, `guardrails{max_nodes, estimated_nodes}`, `fallbacks[]` }
  - `clarify`: { `triggered`, `questions[]`, `options[]`, `causes[]` }
  - `metrics_estimate?`: { `estimated_nodes`, `estimated_edges`, `time_budget` }
  - `extensions?`: { `version`, `tenant?`, `locale?`, `extras?` }

- 约束与枚举：
  - `operator`：`eq|neq|contains|not_contains|starts_with|ends_with|lt|lte|gt|gte|in|not_in|between|exists`
  - `direction`：`in|out|both`
  - `scope`：`node|edge|relation|group`
  - `order`：`asc|desc`

- 标准输出骨架（兼容 v0.1.x，允许 `constraints` 以扁平数组形式出现；推荐 v0.2 结构化）：

```json
{
  "intent": {
    "scenario": "instance_search",
    "output_type": "instances",
    "confidence": 0.86,
    "reasoning": "触发词与类型组合命中实例检索",
    "target_types": ["enterprise"]
  },
  "grounding": {
    "concepts": [{"name": "企业", "type": "enterprise"}],
    "entity_list": [{"text": "企业A", "type": "enterprise"}],
    "entity_candidates": [
      {"text": "企业A", "candidates": ["企业甲", "企业乙"], "confidence": 0.82}
    ],
    "relations": [],
    "target_attributes": []
  },
  "constraints": {
    "filters": [
      {"field": "enterprise.name", "operator": "contains", "value": "新能源", "scope": "node"}
    ],
    "sort": [{"field": "enterprise.created_at", "order": "desc"}],
    "pagination": {"limit": 20, "offset": 0},
    "groups": [],
    "dedup": {"by": "id"}
  },
  "graph_params": {"direction": "out", "depth": 0, "relation_types": []},
  "rag_params": null,
  "plan_hints": {"execution_order": ["entity_binding", "filter_sort"], "guardrails": {"max_nodes": 10000, "estimated_nodes": 120}},
  "clarify": {"triggered": false, "questions": [], "options": [], "causes": []},
  "metrics_estimate": {"estimated_nodes": 120, "estimated_edges": 0, "time_budget": "< 500ms"},
  "extensions": {"version": "v0.2.0", "tenant": "default", "locale": "zh-CN"}
}
```

- 关系/路径/聚合/集合扩展示例：

```json
{
  "intent": {"scenario": "relation_existence", "output_type": "relations", "confidence": 0.93, "reasoning": "触发词'是否'→关系存在性"},
  "grounding": {
    "entity_list": [
      {"text": "企业A", "type": "enterprise"},
      {"text": "园区B", "type": "park"}
    ],
    "relations": [{"type": "enterprise_2_park", "direction": "out"}]
  },
  "graph_params": {"direction": "out", "depth": 1, "relation_types": ["enterprise_2_park"]},
  "constraints": {"filters": [], "sort": [], "pagination": {"limit": 1, "offset": 0}},
  "clarify": {"triggered": false}
}
```

```json
{
  "intent": {"scenario": "path_query", "output_type": "subgraph", "confidence": 0.88, "reasoning": "触发词'路径/经过'→路径查询"},
  "grounding": {
    "entity_list": [{"text": "企业A", "type": "enterprise"}],
    "relations": []
  },
  "graph_params": {
    "direction": "both",
    "depth": 3,
    "relation_types": ["enterprise_2_supplier", "supplier_2_material"],
    "path": {"source_ids": ["ent_123"], "target_types": ["material"], "max_hops": 3}
  },
  "constraints": {"filters": [], "sort": [], "pagination": {"limit": 200, "offset": 0}},
  "clarify": {"triggered": false}
}
```

```json
{
  "intent": {"scenario": "aggregation", "output_type": "instances", "confidence": 0.9, "reasoning": "触发词'数量/平均/Top'→聚合"},
  "grounding": {"concepts": [{"name": "企业", "type": "enterprise"}]},
  "constraints": {
    "aggregation": {
      "metrics": [
        {"name": "count_enterprise", "agg": "count", "on": "node"}
      ],
      "group_by": ["enterprise.type"],
      "having": [],
      "sort": [{"field": "count_enterprise", "order": "desc"}],
      "pagination": {"limit": 10, "offset": 0}
    }
  }
}
```

```json
{
  "intent": {"scenario": "set_ops", "output_type": "instances", "confidence": 0.85, "reasoning": "触发词'并且/或者/差集'→集合运算"},
  "constraints": {
    "groups": [
      {"group_id": "g1", "target_type": "enterprise", "filters": [{"field": "enterprise.name", "operator": "contains", "value": "新能源"}]},
      {"group_id": "g2", "target_type": "enterprise", "filters": [{"field": "enterprise.registered_city", "operator": "eq", "value": "上海"}]}
    ],
    "set_ops": {"lhs": "g1", "op": "intersect", "rhs": "g2"},
    "dedup": {"by": "id"}
  }
}
```

### 紧凑版 Schema c0.2（Codebook，降 token 输出）

- 设计原则：LLM 输出使用代号（Codebook）与紧凑键名，工程侧解码到标准版 v0.2.0，并进行校验/缺省填充。
- 代号表（示意）：
  - 场景：`s`: `IS(instances) | AF(attributes) | RQ(relation) | REX(existence) | PQ(path) | SG(subgraph) | AGG(aggregation) | SET(set_ops) | RAG(text_rag) | CL(clarify) | HY(hybrid)`
  - 输出：`o`: `INST | REL | ATTR | SUBG | TEXT | EXIST`
  - 方向：`dir`: `O(out)|I(in)|B(both)`
  - 操作符：`op`: `EQ|NE|CT|NC|SW|EW|LT|LE|GT|GE|IN|NI|BT|EX`
  - 排序：`ord`: `A|D`
  - 作用域：`sc`: `N|E|R|G`
  - 字段字典：`F{ code -> "type.field" }`
  - 关系字典：`R{ code -> relation_type }`

- 紧凑输出骨架：

```json
{
  "s": "IS",
  "o": "INST",
  "conf": 0.86,
  "tg": ["enterprise"],
  "E": [{"t": "enterprise", "txt": "企业A"}],
  "C": {
    "flt": [{"f": "F001", "op": "CT", "v": "新能源", "sc": "N"}],
    "srt": [{"f": "F010", "ord": "D"}],
    "pg": {"lim": 20, "off": 0},
    "grp": [],
    "dd": {"by": "id"}
  },
  "G": {"dir": "O", "dep": 0, "rel": []},
  "clar": {"tr": false}
}
```

- 工程侧解码（简述）：
  - 仅接受注册代号（严格校验）；
  - 将 `Fxxx/Rxxx` 展开为标准 `field/relation_types`；
  - 缺省填充（如 `pagination.limit`、`dedup.by`）；
  - 与 TBox/能力表对齐字段与限制；
  - 不认识的代号或不合法取值 → 触发 `clarify` 或降级。

### JSON Schema（简化草案，用于校验与 IDE 提示）

```json
{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "IntentContract v0.2.0",
  "type": "object",
  "required": ["intent", "grounding", "constraints", "clarify"],
  "properties": {
    "intent": {
      "type": "object",
      "required": ["scenario", "output_type"],
      "properties": {
        "scenario": {"enum": ["instance_search","attributes_fetch","relation_query","relation_existence","path_query","subgraph","aggregation","set_ops","text_rag","clarify","hybrid"]},
        "output_type": {"enum": ["instances","relations","attributes","subgraph","texts","existence"]},
        "confidence": {"type": "number", "minimum": 0, "maximum": 1}
      }
    },
    "constraints": {
      "type": "object",
      "properties": {
        "filters": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["field", "operator"],
            "properties": {
              "field": {"type": "string"},
              "operator": {"enum": ["eq","neq","contains","not_contains","starts_with","ends_with","lt","lte","gt","gte","in","not_in","between","exists"]},
              "value": {}
            }
          }
        },
        "sort": {"type": "array"},
        "pagination": {"type": "object"}
      }
    }
  }
}
```

### 扩展与版本化约定

- `extensions.version` 作为契约版本号（当前 `v0.2.0`）；紧凑版以 `c0.2` 标识。
- `constraints.groups[]` 统一承载并列/分组过滤；兼容早期 `grouped_filters` 命名。
- 所有新增场景优先落在 `constraints.aggregation` / `constraints.set_ops` / `graph_params.path` / `rag_params` 四个扩展槽位。
- 字段/关系枚举以 TBox 为源，必须通过校验器注册后使用；禁止未注册自由文本字段。
- 兼容策略：保留 v0.1.x 的 `constraints` 扁平数组解析路径；无损升级至 v0.2 结构化。

### 快速示例（跨场景）

```json
// 属性获取
{
  "intent": {"scenario": "attributes_fetch", "output_type": "attributes"},
  "grounding": {"concepts": [{"type": "enterprise"}], "target_attributes": ["enterprise.registered_address"]},
  "constraints": {"filters": []},
  "clarify": {"triggered": false}
}

// 文本RAG
{
  "intent": {"scenario": "text_rag", "output_type": "texts"},
  "rag_params": {"corpora": ["policy_docs"], "top_k": 5, "rerank": true},
  "constraints": {"filters": []},
  "clarify": {"triggered": false}
}
```